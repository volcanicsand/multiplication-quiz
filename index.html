<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Penny's Multiplication Island</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap');

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Nunito', sans-serif;
            background: linear-gradient(180deg,
                #ff7e5f 0%,
                #ff9966 15%,
                #ffb347 30%,
                #ffd1a3 50%,
                #ffe5c4 65%,
                #e8f5e2 85%,
                #c8e6c0 100%);
            background-attachment: fixed;
            min-height: 100vh;
            color: #5c4a32;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 1rem;
        }

        .header {
            text-align: center;
            padding: 1.5rem 0 1rem;
        }

        .header h1 {
            font-size: 1.6rem;
            font-weight: 800;
            color: #3d7c47;
            text-shadow: 1px 1px 0 rgba(255,255,255,0.5);
            line-height: 1.2;
        }

        .header .leaf {
            font-size: 2rem;
            display: block;
            margin-bottom: 0.3rem;
        }

        .header .subtitle {
            font-size: 0.9rem;
            color: #7a9a5a;
            margin-top: 0.3rem;
        }

        .user-status {
            font-size: 0.75rem;
            color: #7a9a5a;
            margin-top: 0.3rem;
            cursor: pointer;
        }

        .user-status:hover {
            text-decoration: underline;
        }

        .score-bar {
            display: flex;
            justify-content: space-around;
            background: rgba(255,255,255,0.7);
            border-radius: 20px;
            padding: 0.6rem 1rem;
            margin-bottom: 1rem;
            font-weight: 700;
            font-size: 0.9rem;
            border: 2px solid rgba(61,124,71,0.15);
        }

        .score-bar span {
            color: #3d7c47;
        }

        .mode-select {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .mode-btn {
            background: rgba(255,255,255,0.8);
            border: 2px solid rgba(61,124,71,0.2);
            border-radius: 12px;
            padding: 0.7rem 0.5rem;
            font-family: 'Nunito', sans-serif;
            font-weight: 700;
            font-size: 0.8rem;
            color: #5c4a32;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .mode-btn:hover {
            background: rgba(255,255,255,1);
            border-color: #3d7c47;
            transform: translateY(-1px);
        }

        .mode-btn.active {
            background: #3d7c47;
            color: white;
            border-color: #3d7c47;
        }

        .mode-btn .mode-icon {
            display: block;
            font-size: 1.3rem;
            margin-bottom: 0.2rem;
        }

        .question-card {
            background: rgba(255,255,255,0.85);
            border-radius: 20px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            border: 2px solid rgba(61,124,71,0.12);
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }

        .question-label {
            font-size: 0.75rem;
            font-weight: 700;
            color: #7a9a5a;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 0.5rem;
        }

        .question-text {
            font-size: 1.8rem;
            font-weight: 800;
            color: #3d5a28;
            line-height: 1.4;
            margin-bottom: 1.2rem;
            text-align: center;
        }

        .question-text .highlight {
            color: #c0732a;
        }

        .answer-area {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            justify-content: center;
        }

        .answer-input {
            width: 120px;
            padding: 0.8rem 1rem;
            font-family: 'Nunito', sans-serif;
            font-weight: 700;
            font-size: 1.4rem;
            text-align: center;
            border: 3px solid rgba(61,124,71,0.3);
            border-radius: 12px;
            background: #f0f7ec;
            color: #3d5a28;
            outline: none;
            transition: border-color 0.2s;
        }

        .answer-input:focus {
            border-color: #3d7c47;
        }

        .answer-input.correct {
            border-color: #3d7c47;
            background: #c8e6c0;
        }

        .answer-input.wrong {
            border-color: #c0732a;
            background: #f5d0c0;
        }

        .submit-btn {
            background: #3d7c47;
            color: white;
            border: none;
            border-radius: 12px;
            padding: 0.8rem 1.5rem;
            font-family: 'Nunito', sans-serif;
            font-weight: 700;
            font-size: 1.1rem;
            cursor: pointer;
            transition: background 0.2s;
        }

        .submit-btn:hover {
            background: #2d5a33;
        }

        .feedback {
            text-align: center;
            padding: 1rem;
            font-weight: 700;
            font-size: 1.1rem;
            border-radius: 12px;
            margin-top: 1rem;
            display: none;
        }

        .feedback.correct {
            display: block;
            background: #d4edda;
            color: #2d5a1e;
            font-family: 'Brush Script MT', 'Segoe Script', cursive;
            font-size: 1.3rem;
        }

        .feedback.wrong {
            display: block;
            background: #fde8e0;
            color: #8b4513;
        }

        .next-btn {
            display: none;
            width: 100%;
            background: #3d7c47;
            color: white;
            border: none;
            border-radius: 12px;
            padding: 0.9rem;
            font-family: 'Nunito', sans-serif;
            font-weight: 700;
            font-size: 1.05rem;
            cursor: pointer;
            margin-top: 0.8rem;
            transition: background 0.2s;
        }

        .next-btn:hover {
            background: #2d5a33;
        }

        .streak-display {
            text-align: center;
            font-size: 0.85rem;
            color: #7a9a5a;
            font-weight: 600;
            margin-top: 0.3rem;
        }

        .round-end {
            text-align: center;
            padding: 1.5rem;
        }

        .round-end h2 {
            color: #3d7c47;
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .round-end .final-score {
            font-size: 2.5rem;
            font-weight: 800;
            color: #c0732a;
            margin: 0.5rem 0;
        }

        .round-end .final-msg {
            font-size: 1rem;
            color: #5c4a32;
            margin-bottom: 1rem;
        }

        .round-end .final-details {
            font-size: 0.9rem;
            color: #7a9a5a;
            margin-bottom: 1.2rem;
        }

        .play-again-btn {
            background: #3d7c47;
            color: white;
            border: none;
            border-radius: 12px;
            padding: 0.9rem 2rem;
            font-family: 'Nunito', sans-serif;
            font-weight: 700;
            font-size: 1.05rem;
            cursor: pointer;
            transition: background 0.2s;
        }

        .play-again-btn:hover {
            background: #2d5a33;
        }

        .step-tracker {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .step-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: rgba(61,124,71,0.2);
            transition: background 0.3s;
        }

        .step-dot.done {
            background: #3d7c47;
        }

        .step-dot.active {
            background: #c0732a;
            box-shadow: 0 0 6px rgba(192,115,42,0.4);
        }

        .breakdown-hint {
            text-align: center;
            font-size: 0.85rem;
            color: #7a9a5a;
            font-weight: 600;
            margin-bottom: 0.8rem;
        }

        .fun-fact {
            font-size: 0.85rem;
            color: #7a9a5a;
            font-style: italic;
            margin-top: 0.5rem;
            text-align: center;
        }

        /* Login screen */
        .login-screen {
            text-align: center;
            padding: 2rem 1rem;
        }

        .login-screen h2 {
            color: #3d7c47;
            font-size: 1.3rem;
            margin-bottom: 0.5rem;
        }

        .login-screen p {
            color: #7a9a5a;
            font-size: 0.9rem;
            margin-bottom: 1.5rem;
        }

        .login-screen input {
            display: block;
            width: 100%;
            max-width: 280px;
            margin: 0 auto 0.8rem;
            padding: 0.7rem 1rem;
            font-family: 'Nunito', sans-serif;
            font-size: 0.95rem;
            border: 2px solid rgba(61,124,71,0.3);
            border-radius: 10px;
            background: #f0f7ec;
            color: #3d5a28;
            outline: none;
        }

        .login-screen input:focus {
            border-color: #3d7c47;
        }

        .login-btn {
            background: #3d7c47;
            color: white;
            border: none;
            border-radius: 10px;
            padding: 0.7rem 2rem;
            font-family: 'Nunito', sans-serif;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            transition: background 0.2s;
        }

        .login-btn:hover {
            background: #2d5a33;
        }

        .login-error {
            color: #c0732a;
            font-size: 0.85rem;
            font-weight: 600;
            margin-top: 0.8rem;
            display: none;
        }

        /* Keep Practicing view */
        .practice-view h3 {
            color: #3d7c47;
            font-size: 1.2rem;
            margin-bottom: 0.3rem;
            text-align: center;
        }

        .practice-view .practice-subtitle {
            color: #7a9a5a;
            font-size: 0.9rem;
            text-align: center;
            margin-bottom: 1.2rem;
        }

        .practice-item {
            display: flex;
            align-items: center;
            gap: 0.8rem;
            padding: 0.6rem 0;
            border-bottom: 1px solid rgba(61,124,71,0.1);
        }

        .practice-item:last-child {
            border-bottom: none;
        }

        .practice-problem {
            font-weight: 800;
            font-size: 1.1rem;
            color: #3d5a28;
            min-width: 55px;
        }

        .practice-bar-wrap {
            flex: 1;
            background: rgba(61,124,71,0.1);
            border-radius: 8px;
            height: 14px;
            overflow: hidden;
        }

        .practice-bar-fill {
            height: 100%;
            border-radius: 8px;
            background: linear-gradient(90deg, #c0732a, #3d7c47);
            transition: width 0.5s;
        }

        .practice-pct {
            font-weight: 700;
            font-size: 0.85rem;
            color: #7a9a5a;
            min-width: 40px;
            text-align: right;
        }

        .practice-empty {
            text-align: center;
            padding: 2rem 1rem;
            color: #7a9a5a;
            font-size: 1rem;
        }

        .practice-empty .practice-empty-icon {
            font-size: 2rem;
            display: block;
            margin-bottom: 0.5rem;
        }

        .back-btn {
            display: block;
            width: 100%;
            background: rgba(61,124,71,0.1);
            color: #3d7c47;
            border: 2px solid rgba(61,124,71,0.2);
            border-radius: 12px;
            padding: 0.7rem;
            font-family: 'Nunito', sans-serif;
            font-weight: 700;
            font-size: 0.95rem;
            cursor: pointer;
            margin-top: 1rem;
            transition: all 0.2s;
        }

        .back-btn:hover {
            background: rgba(61,124,71,0.2);
        }

        /* Round end enhancements */
        .round-missed {
            text-align: left;
            margin: 1rem 0;
            padding: 0.8rem;
            background: rgba(192,115,42,0.08);
            border-radius: 10px;
        }

        .round-missed h4 {
            color: #c0732a;
            font-size: 0.85rem;
            margin-bottom: 0.4rem;
        }

        .round-missed-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.4rem;
        }

        .round-missed-tag {
            background: rgba(192,115,42,0.15);
            color: #8b4513;
            padding: 0.2rem 0.6rem;
            border-radius: 8px;
            font-weight: 700;
            font-size: 0.85rem;
        }

        .alltime-stats {
            font-size: 0.85rem;
            color: #7a9a5a;
            margin-top: 0.5rem;
        }

        /* Level selector */
        .level-select {
            display: flex;
            gap: 0.4rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        .level-btn {
            background: rgba(255,255,255,0.8);
            border: 2px solid rgba(61,124,71,0.2);
            border-radius: 10px;
            padding: 0.45rem 0.7rem;
            font-family: 'Nunito', sans-serif;
            font-weight: 700;
            font-size: 0.75rem;
            color: #5c4a32;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            white-space: nowrap;
        }

        .level-btn:hover:not(.locked) {
            background: rgba(255,255,255,1);
            border-color: #3d7c47;
            transform: translateY(-1px);
        }

        .level-btn.active {
            background: #3d7c47;
            color: white;
            border-color: #3d7c47;
        }

        .level-btn.locked {
            opacity: 0.45;
            cursor: not-allowed;
            filter: grayscale(0.5);
        }

        .level-btn .level-icon {
            margin-right: 0.2rem;
        }

        /* Level unlock celebration */
        .unlock-msg {
            text-align: center;
            background: linear-gradient(135deg, #d4edda 0%, #fff8e1 100%);
            border: 2px solid #3d7c47;
            border-radius: 14px;
            padding: 1rem 1.2rem;
            margin: 1rem 0;
            animation: unlockPop 0.5s ease-out;
        }

        .unlock-msg .unlock-icon {
            font-size: 2rem;
            display: block;
            margin-bottom: 0.3rem;
        }

        .unlock-msg .unlock-title {
            font-weight: 800;
            font-size: 1.1rem;
            color: #3d7c47;
        }

        .unlock-msg .unlock-detail {
            font-size: 0.9rem;
            color: #5c4a32;
            margin-top: 0.2rem;
        }

        @keyframes unlockPop {
            0% { transform: scale(0.8); opacity: 0; }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); opacity: 1; }
        }

        /* Prize Tracker */
        .prize-tracker-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.4rem;
            background: rgba(255,255,255,0.7);
            border: 2px solid rgba(192,115,42,0.2);
            border-radius: 12px;
            padding: 0.45rem 1rem;
            margin-bottom: 1rem;
            font-family: 'Nunito', sans-serif;
            font-weight: 700;
            font-size: 0.85rem;
            color: #c0732a;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .prize-tracker-btn:hover {
            background: rgba(255,255,255,1);
            border-color: #c0732a;
            transform: translateY(-1px);
        }

        .prize-tracker-btn .prize-mini-bar {
            width: 60px;
            height: 8px;
            background: rgba(192,115,42,0.15);
            border-radius: 4px;
            overflow: hidden;
        }

        .prize-tracker-btn .prize-mini-fill {
            height: 100%;
            background: linear-gradient(90deg, #c0732a, #3d7c47);
            border-radius: 4px;
            transition: width 0.5s;
        }

        .prize-view h3 {
            color: #3d7c47;
            font-size: 1.2rem;
            margin-bottom: 0.2rem;
            text-align: center;
        }

        .prize-view .prize-subtitle {
            color: #7a9a5a;
            font-size: 0.9rem;
            text-align: center;
            margin-bottom: 0.8rem;
        }

        .prize-progress-bar {
            background: rgba(61,124,71,0.1);
            border-radius: 10px;
            height: 18px;
            overflow: hidden;
            margin-bottom: 1.2rem;
            position: relative;
        }

        .prize-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #c0732a, #3d7c47);
            border-radius: 10px;
            transition: width 0.5s;
        }

        .prize-progress-label {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 800;
            color: #3d5a28;
        }

        .prize-item {
            display: flex;
            align-items: center;
            gap: 0.6rem;
            padding: 0.6rem 0.5rem;
            border-radius: 10px;
            margin-bottom: 0.3rem;
            transition: background 0.2s;
        }

        .prize-item.earned {
            background: rgba(61,124,71,0.08);
        }

        .prize-item.next-up {
            background: rgba(192,115,42,0.1);
            border: 2px solid rgba(192,115,42,0.25);
        }

        .prize-item.future {
            opacity: 0.5;
        }

        .prize-item-icon {
            font-size: 1.2rem;
            min-width: 28px;
            text-align: center;
        }

        .prize-item-info {
            flex: 1;
        }

        .prize-item-milestone {
            font-weight: 800;
            font-size: 0.85rem;
            color: #3d5a28;
        }

        .prize-item-name {
            font-size: 0.8rem;
            color: #7a9a5a;
            font-weight: 600;
        }

        .prize-item.earned .prize-item-name {
            color: #3d7c47;
        }

        .prize-item.next-up .prize-item-name {
            color: #c0732a;
        }

        .prize-edit-link {
            display: block;
            text-align: center;
            margin-top: 0.8rem;
            margin-bottom: 0.5rem;
            font-size: 0.8rem;
            font-weight: 700;
            color: #7a9a5a;
            cursor: pointer;
            text-decoration: underline;
        }

        .prize-edit-link:hover {
            color: #3d7c47;
        }

        .prize-edit-row {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.4rem;
        }

        .prize-edit-label {
            font-weight: 800;
            font-size: 0.8rem;
            color: #3d5a28;
            min-width: 50px;
        }

        .prize-edit-input {
            flex: 1;
            padding: 0.4rem 0.6rem;
            font-family: 'Nunito', sans-serif;
            font-size: 0.85rem;
            border: 2px solid rgba(61,124,71,0.3);
            border-radius: 8px;
            background: #f0f7ec;
            color: #3d5a28;
            outline: none;
        }

        .prize-edit-input:focus {
            border-color: #3d7c47;
        }

        .prize-save-btn {
            display: block;
            width: 100%;
            background: #3d7c47;
            color: white;
            border: none;
            border-radius: 10px;
            padding: 0.6rem;
            font-family: 'Nunito', sans-serif;
            font-weight: 700;
            font-size: 0.9rem;
            cursor: pointer;
            margin-top: 0.6rem;
            transition: background 0.2s;
        }

        .prize-save-btn:hover {
            background: #2d5a33;
        }

        .prize-earned-msg {
            text-align: center;
            background: linear-gradient(135deg, #fff8e1 0%, #d4edda 100%);
            border: 2px solid #c0732a;
            border-radius: 14px;
            padding: 1rem 1.2rem;
            margin: 1rem 0;
            animation: unlockPop 0.5s ease-out;
        }

        .prize-earned-msg .prize-earned-icon {
            font-size: 2rem;
            display: block;
            margin-bottom: 0.3rem;
        }

        .prize-earned-msg .prize-earned-title {
            font-weight: 800;
            font-size: 1.1rem;
            color: #c0732a;
        }

        .prize-earned-msg .prize-earned-detail {
            font-size: 0.9rem;
            color: #5c4a32;
            margin-top: 0.2rem;
        }

        /* Island Place Unlock */
        .place-unlock-msg {
            text-align: center;
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 25%, #a1c4fd 50%, #c2e9fb 75%, #d4fc79 100%);
            background-size: 300% 300%;
            animation: placeUnlock 0.8s ease-out, gradientShift 3s ease infinite;
            border: 4px solid #3d7c47;
            border-radius: 20px;
            padding: 1.5rem 1.2rem;
            margin: 1rem 0;
            box-shadow: 0 0 20px rgba(61,124,71,0.3), 0 0 40px rgba(252,182,159,0.2);
            position: relative;
            overflow: hidden;
        }

        .place-unlock-msg::before {
            content: '‚ú®';
            position: absolute;
            font-size: 1.5rem;
            top: 10px;
            left: 15px;
            animation: sparkle 1s ease-in-out infinite;
        }

        .place-unlock-msg::after {
            content: '‚ú®';
            position: absolute;
            font-size: 1.5rem;
            top: 10px;
            right: 15px;
            animation: sparkle 1s ease-in-out infinite 0.5s;
        }

        .place-unlock-msg .place-icon {
            font-size: 5rem;
            display: block;
            margin-bottom: 0.5rem;
            animation: iconReveal 1s ease-out;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.2));
        }

        .place-unlock-msg .place-title {
            font-weight: 800;
            font-size: 0.9rem;
            color: #3d7c47;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 0.3rem;
            animation: fadeSlideUp 0.6s ease-out 0.3s both;
        }

        .place-unlock-msg .place-name {
            font-weight: 800;
            font-size: 1.6rem;
            color: #5c4a32;
            margin: 0.4rem 0;
            text-shadow: 1px 1px 0 rgba(255,255,255,0.5);
            animation: fadeSlideUp 0.6s ease-out 0.5s both;
        }

        .place-unlock-msg .place-desc {
            font-size: 1rem;
            color: #6b5a42;
            font-style: italic;
            animation: fadeSlideUp 0.6s ease-out 0.7s both;
        }

        .place-unlock-msg .place-stars {
            margin-top: 0.8rem;
            font-size: 1.5rem;
            animation: fadeSlideUp 0.6s ease-out 0.9s both;
        }

        @keyframes placeUnlock {
            0% { transform: scale(0.3) rotate(-10deg); opacity: 0; }
            50% { transform: scale(1.1) rotate(3deg); }
            70% { transform: scale(0.95) rotate(-1deg); }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        @keyframes iconReveal {
            0% { transform: scale(0) rotate(-180deg); opacity: 0; }
            50% { transform: scale(1.3) rotate(10deg); }
            75% { transform: scale(0.9) rotate(-5deg); }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }

        @keyframes fadeSlideUp {
            0% { transform: translateY(20px); opacity: 0; }
            100% { transform: translateY(0); opacity: 1; }
        }

        @keyframes sparkle {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.3); }
        }

        /* Confetti */
        .confetti-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1000;
            overflow: hidden;
        }

        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            top: -10px;
            animation: confettiFall 3s ease-out forwards;
        }

        @keyframes confettiFall {
            0% { transform: translateY(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }

        /* Mascot */
        .mascot {
            position: fixed;
            bottom: 20px;
            right: 20px;
            font-size: 3rem;
            transition: transform 0.3s;
            z-index: 100;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
        }

        .mascot.happy {
            animation: mascotHappy 0.5s ease-out;
        }

        .mascot.sad {
            animation: mascotSad 0.5s ease-out;
        }

        @keyframes mascotHappy {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            25% { transform: translateY(-15px) rotate(-10deg); }
            50% { transform: translateY(-5px) rotate(10deg); }
            75% { transform: translateY(-10px) rotate(-5deg); }
        }

        @keyframes mascotSad {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(5px); }
        }

        /* Double Points Round */
        .double-points-active .question-card {
            background: linear-gradient(135deg, #fff8e1 0%, #ffecb3 100%);
            border: 3px solid #ffc107;
            box-shadow: 0 0 20px rgba(255,193,7,0.3);
        }

        .double-points-badge {
            display: inline-block;
            background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
            color: white;
            font-weight: 800;
            font-size: 0.75rem;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            margin-bottom: 0.8rem;
            animation: pulseBadge 1s ease-in-out infinite;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        @keyframes pulseBadge {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* Running Character */
        .runner {
            position: fixed;
            bottom: 80px;
            left: -60px;
            width: 40px;
            height: 60px;
            z-index: 50;
            pointer-events: none;
        }

        .runner svg {
            width: 100%;
            height: 100%;
        }

        .runner.running {
            animation: runAcross 2s ease-in-out forwards;
        }

        @keyframes runAcross {
            0% { left: -60px; }
            100% { left: calc(100% + 60px); }
        }

        .runner .body {
            fill: #ffb74d;
        }
        .runner .head {
            fill: #ffcc80;
        }
        .runner .eyes {
            fill: #5d4037;
        }
        .runner .mouth {
            fill: #e65100;
        }
        .runner .hair {
            fill: #8d6e63;
        }
        .runner .shirt {
            fill: #4fc3f7;
        }
        .runner .pants {
            fill: #7986cb;
        }
        .runner .shoes {
            fill: #f44336;
        }

        .runner.running .legs {
            animation: legMove 0.2s ease-in-out infinite alternate;
        }

        .runner.running .arms {
            animation: armMove 0.2s ease-in-out infinite alternate-reverse;
        }

        @keyframes legMove {
            0% { transform: rotate(-20deg); }
            100% { transform: rotate(20deg); }
        }

        @keyframes armMove {
            0% { transform: rotate(20deg); }
            100% { transform: rotate(-20deg); }
        }

        /* Daily Streak */
        .daily-streak-display {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            background: rgba(255,152,0,0.15);
            padding: 0.2rem 0.6rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 700;
            color: #e65100;
            margin-left: 0.5rem;
        }

        .streak-flame {
            animation: flicker 0.5s ease-in-out infinite alternate;
        }

        @keyframes flicker {
            0% { transform: scale(1); }
            100% { transform: scale(1.1); }
        }

        /* Island Name */
        .island-name-input {
            display: block;
            width: 100%;
            max-width: 200px;
            margin: 0.5rem auto;
            padding: 0.4rem 0.8rem;
            font-family: 'Nunito', sans-serif;
            font-size: 0.85rem;
            font-weight: 600;
            border: 2px solid rgba(61,124,71,0.3);
            border-radius: 8px;
            background: #f0f7ec;
            color: #3d5a28;
            text-align: center;
            outline: none;
        }

        .island-name-input:focus {
            border-color: #3d7c47;
        }

        /* Emoji Applause Crowd */
        .applause-crowd {
            display: flex;
            justify-content: center;
            gap: 0.3rem;
            font-size: 2rem;
            margin: 1rem 0;
            flex-wrap: wrap;
        }

        .applause-crowd span {
            animation: crowdBounce 0.5s ease-in-out infinite;
        }

        .applause-crowd span:nth-child(1) { animation-delay: 0s; }
        .applause-crowd span:nth-child(2) { animation-delay: 0.1s; }
        .applause-crowd span:nth-child(3) { animation-delay: 0.2s; }
        .applause-crowd span:nth-child(4) { animation-delay: 0.3s; }
        .applause-crowd span:nth-child(5) { animation-delay: 0.4s; }
        .applause-crowd span:nth-child(6) { animation-delay: 0.5s; }
        .applause-crowd span:nth-child(7) { animation-delay: 0.6s; }
        .applause-crowd span:nth-child(8) { animation-delay: 0.7s; }
        .applause-crowd span:nth-child(9) { animation-delay: 0.8s; }

        @keyframes crowdBounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }

        /* Floating Stars/Sparkles Background */
        .sparkle {
            position: fixed;
            pointer-events: none;
            z-index: -1;
            animation: twinkle 2s ease-in-out infinite;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.2); }
        }

        /* Level Up Animation */
        .level-up-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            animation: fadeIn 0.3s ease-out;
        }

        .level-up-content {
            text-align: center;
            animation: levelUpPop 0.6s ease-out;
        }

        .level-up-content .level-icon {
            font-size: 5rem;
            display: block;
            margin-bottom: 1rem;
            animation: levelIconSpin 1s ease-out;
        }

        .level-up-content .level-text {
            font-size: 2rem;
            font-weight: 800;
            color: #ffd700;
            text-shadow: 0 0 20px rgba(255,215,0,0.8);
        }

        .level-up-content .level-name {
            font-size: 1.5rem;
            font-weight: 700;
            color: white;
            margin-top: 0.5rem;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes levelUpPop {
            0% { transform: scale(0); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        @keyframes levelIconSpin {
            0% { transform: rotateY(0deg); }
            100% { transform: rotateY(360deg); }
        }

        /* Combo Multiplier */
        .combo-display {
            position: fixed;
            top: 100px;
            right: 20px;
            background: linear-gradient(135deg, #ff6b6b 0%, #feca57 100%);
            color: white;
            font-weight: 800;
            font-size: 1.2rem;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            z-index: 100;
            animation: comboPulse 0.5s ease-in-out infinite;
            box-shadow: 0 4px 15px rgba(255,107,107,0.4);
            display: none;
        }

        .combo-display.active {
            display: block;
        }

        @keyframes comboPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        /* Achievements/Badges */
        .badge-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem 2rem;
            border-radius: 20px;
            z-index: 2000;
            text-align: center;
            animation: badgePop 0.5s ease-out;
            box-shadow: 0 10px 40px rgba(102,126,234,0.5);
        }

        .badge-popup .badge-icon {
            font-size: 3rem;
            display: block;
            margin-bottom: 0.5rem;
        }

        .badge-popup .badge-title {
            font-size: 1.3rem;
            font-weight: 800;
        }

        .badge-popup .badge-desc {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-top: 0.3rem;
        }

        @keyframes badgePop {
            0% { transform: translate(-50%, -50%) scale(0) rotate(-10deg); }
            50% { transform: translate(-50%, -50%) scale(1.1) rotate(5deg); }
            100% { transform: translate(-50%, -50%) scale(1) rotate(0deg); }
        }

        /* Weather Effects */
        .weather-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
            overflow: hidden;
        }

        .raindrop {
            position: absolute;
            width: 2px;
            height: 15px;
            background: linear-gradient(transparent, rgba(174,194,224,0.6));
            animation: rain 0.8s linear infinite;
        }

        @keyframes rain {
            0% { transform: translateY(-20px); }
            100% { transform: translateY(100vh); }
        }

        .snowflake {
            position: absolute;
            color: white;
            font-size: 1rem;
            animation: snow 4s linear infinite;
            text-shadow: 0 0 5px rgba(255,255,255,0.8);
        }

        @keyframes snow {
            0% { transform: translateY(-20px) rotate(0deg); }
            100% { transform: translateY(100vh) rotate(360deg); }
        }

        .sunray {
            position: absolute;
            top: -50px;
            width: 4px;
            height: 150px;
            background: linear-gradient(rgba(255,255,200,0.6), transparent);
            animation: sunray 3s ease-in-out infinite;
        }

        @keyframes sunray {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 0.7; }
        }

        /* Leaderboard */
        .leaderboard-view h3 {
            color: #3d7c47;
            text-align: center;
            margin-bottom: 1rem;
        }

        .leaderboard-item {
            display: flex;
            align-items: center;
            gap: 0.8rem;
            padding: 0.6rem;
            background: rgba(255,255,255,0.5);
            border-radius: 10px;
            margin-bottom: 0.5rem;
        }

        .leaderboard-item.mine {
            background: rgba(61,124,71,0.15);
            border: 2px solid #3d7c47;
        }

        .leaderboard-rank {
            font-size: 1.2rem;
            font-weight: 800;
            min-width: 30px;
        }

        .leaderboard-name {
            flex: 1;
            font-weight: 600;
        }

        .leaderboard-score {
            font-weight: 800;
            color: #c0732a;
        }

        /* Avatar Creator */
        .avatar-creator {
            text-align: center;
            padding: 1rem;
        }

        .avatar-preview {
            width: 80px;
            height: 120px;
            margin: 0 auto 1rem;
        }

        .avatar-options {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            justify-content: center;
            margin-bottom: 0.5rem;
        }

        .avatar-option {
            width: 36px;
            height: 36px;
            border: 2px solid #e5e7eb;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s;
        }

        .avatar-option:hover, .avatar-option.selected {
            border-color: #3d7c47;
            transform: scale(1.1);
        }

        .avatar-label {
            font-size: 0.8rem;
            font-weight: 600;
            color: #7a9a5a;
            margin: 0.8rem 0 0.3rem;
        }

        /* Bonus Question */
        .bonus-question .question-card {
            background: linear-gradient(135deg, #ffd700 0%, #ffec8b 50%, #ffd700 100%);
            border: 3px solid #daa520;
            animation: bonusGlow 1s ease-in-out infinite alternate;
        }

        @keyframes bonusGlow {
            from { box-shadow: 0 0 10px rgba(255,215,0,0.5); }
            to { box-shadow: 0 0 25px rgba(255,215,0,0.8); }
        }

        .bonus-badge {
            background: linear-gradient(135deg, #daa520, #ffd700);
            color: #5c4a32;
            font-weight: 800;
            padding: 0.3rem 1rem;
            border-radius: 20px;
            display: inline-block;
            margin-bottom: 0.8rem;
            animation: pulseBadge 0.5s ease-in-out infinite;
        }

        /* Difficulty Selector */
        .difficulty-select {
            display: flex;
            gap: 0.3rem;
            justify-content: center;
            margin-bottom: 0.8rem;
        }

        .difficulty-btn {
            padding: 0.3rem 0.8rem;
            border: 2px solid #e5e7eb;
            border-radius: 15px;
            background: white;
            font-family: inherit;
            font-weight: 600;
            font-size: 0.7rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .difficulty-btn:hover {
            border-color: #3d7c47;
        }

        .difficulty-btn.active {
            background: #3d7c47;
            color: white;
            border-color: #3d7c47;
        }

        .difficulty-btn.easy { color: #22c55e; }
        .difficulty-btn.easy.active { background: #22c55e; color: white; border-color: #22c55e; }
        .difficulty-btn.hard { color: #ef4444; }
        .difficulty-btn.hard.active { background: #ef4444; color: white; border-color: #ef4444; }

        /* Power-ups */
        .powerups-bar {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
            margin-bottom: 0.8rem;
        }

        .powerup-btn {
            display: flex;
            align-items: center;
            gap: 0.3rem;
            padding: 0.3rem 0.6rem;
            border: 2px solid #e5e7eb;
            border-radius: 20px;
            background: white;
            font-family: inherit;
            font-weight: 600;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .powerup-btn:hover:not(:disabled) {
            border-color: #3d7c47;
            transform: scale(1.05);
        }

        .powerup-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .powerup-count {
            background: #3d7c47;
            color: white;
            padding: 0.1rem 0.4rem;
            border-radius: 10px;
            font-size: 0.7rem;
        }

        /* Seasonal Themes */
        body.theme-halloween {
            background: linear-gradient(180deg, #1a0a2e 0%, #2d1b4e 30%, #4a2c6a 60%, #ff6b35 100%);
        }

        body.theme-christmas {
            background: linear-gradient(180deg, #1e3a5f 0%, #2e5a7e 30%, #c41e3a 60%, #228b22 100%);
        }

        body.theme-summer {
            background: linear-gradient(180deg, #87ceeb 0%, #98d8c8 30%, #f7dc6f 60%, #f39c12 100%);
        }

        /* Collectibles */
        .collectibles-bar {
            display: flex;
            gap: 0.8rem;
            justify-content: center;
            padding: 0.5rem;
            background: rgba(255,255,255,0.7);
            border-radius: 20px;
            margin-bottom: 0.8rem;
            font-size: 0.85rem;
        }

        .collectible-item {
            display: flex;
            align-items: center;
            gap: 0.2rem;
        }

        .collectible-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 3rem;
            animation: collectiblePop 1s ease-out forwards;
            z-index: 1000;
            pointer-events: none;
        }

        @keyframes collectiblePop {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 1; }
            50% { transform: translate(-50%, -50%) scale(1.5); opacity: 1; }
            100% { transform: translate(-50%, -100%) scale(1); opacity: 0; }
        }

        /* Mini-games */
        .minigame-unlock {
            text-align: center;
            padding: 1rem;
            background: linear-gradient(135deg, #a8e6cf 0%, #dcedc1 100%);
            border-radius: 12px;
            margin: 1rem 0;
        }

        .minigame-btn {
            background: #3d7c47;
            color: white;
            border: none;
            border-radius: 10px;
            padding: 0.6rem 1.2rem;
            font-family: inherit;
            font-weight: 700;
            cursor: pointer;
            margin-top: 0.5rem;
        }

        .bug-game {
            position: relative;
            height: 200px;
            background: linear-gradient(180deg, #87ceeb 0%, #90ee90 100%);
            border-radius: 12px;
            overflow: hidden;
            margin: 1rem 0;
        }

        .bug {
            position: absolute;
            font-size: 2rem;
            cursor: pointer;
            transition: transform 0.1s;
            user-select: none;
        }

        .bug:hover {
            transform: scale(1.2);
        }

        /* Progress Map */
        .progress-map {
            position: relative;
            width: 100%;
            height: 300px;
            background: linear-gradient(180deg, #87ceeb 0%, #90ee90 50%, #f4a460 100%);
            border-radius: 16px;
            overflow: hidden;
            margin: 1rem 0;
        }

        .map-place {
            position: absolute;
            text-align: center;
            transition: all 0.3s;
        }

        .map-place.locked {
            filter: grayscale(1);
            opacity: 0.4;
        }

        .map-place .place-icon {
            font-size: 2rem;
            display: block;
        }

        .map-place .place-label {
            font-size: 0.6rem;
            font-weight: 700;
            color: #5c4a32;
            background: rgba(255,255,255,0.8);
            padding: 0.1rem 0.3rem;
            border-radius: 4px;
        }

        /* Theme selector */
        .theme-select {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
            margin: 0.5rem 0;
        }

        .theme-btn {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 2px solid #e5e7eb;
            cursor: pointer;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .theme-btn:hover, .theme-btn.active {
            border-color: #3d7c47;
            transform: scale(1.1);
        }

        /* Music toggle */
        .music-toggle {
            position: fixed;
            bottom: 20px;
            left: 20px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255,255,255,0.9);
            border: 2px solid #3d7c47;
            font-size: 1.2rem;
            cursor: pointer;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .music-toggle.muted {
            opacity: 0.5;
        }

        @media (max-width: 400px) {
            .header h1 { font-size: 1.3rem; }
            .question-text { font-size: 1.4rem; }
            .answer-input { font-size: 1.2rem; width: 100px; }
            .mode-select { grid-template-columns: 1fr 1fr; }
            .mode-select .mode-btn:nth-child(3) { grid-column: 1 / -1; }
            .level-btn { font-size: 0.7rem; padding: 0.35rem 0.55rem; }
        }
    </style>
</head>
<body>
    <div id="confetti-container" class="confetti-container"></div>
    <div id="weather-container" class="weather-container"></div>
    <div class="mascot" id="mascot">ü¶ù</div>
    <div class="combo-display" id="combo-display">üî• x3 Combo!</div>

    <!-- Running character -->
    <div class="runner" id="runner">
        <svg viewBox="0 0 40 60" xmlns="http://www.w3.org/2000/svg">
            <!-- Hair -->
            <ellipse class="hair" cx="20" cy="8" rx="10" ry="8"/>
            <!-- Head -->
            <circle class="head" cx="20" cy="12" r="9"/>
            <!-- Eyes -->
            <circle class="eyes" cx="16" cy="11" r="2"/>
            <circle class="eyes" cx="24" cy="11" r="2"/>
            <!-- Happy mouth -->
            <path class="mouth" d="M 16 16 Q 20 20 24 16" fill="none" stroke="#e65100" stroke-width="1.5" stroke-linecap="round"/>
            <!-- Body/Shirt -->
            <rect class="shirt" x="12" y="21" width="16" height="14" rx="3"/>
            <!-- Arms -->
            <g class="arms" style="transform-origin: 12px 24px;">
                <rect class="shirt" x="4" y="22" width="8" height="4" rx="2"/>
            </g>
            <g class="arms" style="transform-origin: 28px 24px;">
                <rect class="shirt" x="28" y="22" width="8" height="4" rx="2"/>
            </g>
            <!-- Pants -->
            <rect class="pants" x="12" y="35" width="7" height="12" rx="2"/>
            <rect class="pants" x="21" y="35" width="7" height="12" rx="2"/>
            <!-- Shoes -->
            <ellipse class="shoes" cx="15" cy="50" rx="5" ry="3"/>
            <ellipse class="shoes" cx="25" cy="50" rx="5" ry="3"/>
        </svg>
    </div>

    <div class="container">
        <div class="header">
            <span class="leaf">üçÉ</span>
            <h1 id="island-title">Penny's Multiplication<br>Island</h1>
            <div class="subtitle">Practice your times tables, island-style!</div>
            <button onclick="showIslandNamePrompt()" style="background:none; border:1px solid #7a9a5a; border-radius:8px; padding:0.2rem 0.6rem; font-size:0.7rem; color:#7a9a5a; cursor:pointer; margin-top:0.3rem; font-family:inherit;">‚úèÔ∏è Rename Island</button>
            <div class="user-status" id="user-status" onclick="handleUserStatusClick()"></div>
        </div>

        <div id="login-screen" class="question-card" style="display:none;">
            <div class="login-screen">
                <h2>Welcome to the Island!</h2>
                <p>A parent can log in to save your progress.</p>
                <input type="email" id="login-email" placeholder="Email" autocomplete="email">
                <input type="password" id="login-password" placeholder="Password" autocomplete="current-password">
                <button class="login-btn" onclick="doLogin()">Log In</button>
                <div class="login-error" id="login-error"></div>
            </div>
        </div>

        <div id="game-area">
            <div class="score-bar">
                <div>Q: <span id="qnum">1</span>/<span id="qtotal">20</span></div>
                <div>Score: <span id="score">0</span></div>
                <div>Streak: <span id="streak">0</span></div>
            </div>

            <div class="mode-select">
                <button class="mode-btn active" id="btn-times" onclick="setMode('times', this)">
                    <span class="mode-icon">üåü</span>Times Tables
                </button>
                <button class="mode-btn" id="btn-breakdown" onclick="setMode('breakdown', this)">
                    <span class="mode-icon">üß©</span>Break It Down
                </button>
                <button class="mode-btn" id="btn-practice" onclick="showPracticeView()">
                    <span class="mode-icon">üéØ</span>Keep Practicing
                </button>
            </div>

            <div class="level-select" id="level-select"></div>

            <div class="prize-tracker-btn" id="prize-tracker-btn" onclick="showPrizeView()" style="display:none;">
                <span>üèÜ <span id="prize-progress-text">0/50</span></span>
                <div class="prize-mini-bar"><div class="prize-mini-fill" id="prize-mini-fill" style="width:0%"></div></div>
            </div>

            <div class="question-card" id="card">
                <div class="question-label" id="q-label">Times Tables</div>
                <div class="question-text" id="q-text">Press a mode to start!</div>
                <div id="extra"></div>
                <div class="answer-area" id="answer-area">
                    <input type="number" class="answer-input" id="answer-input" autocomplete="off">
                    <button class="submit-btn" id="submit-btn" onclick="submitAnswer()">Go!</button>
                </div>
                <div class="feedback" id="feedback"></div>
                <button class="next-btn" id="next-btn" onclick="nextQuestion()">Next Question</button>
            </div>
            <div class="streak-display" id="streak-msg"></div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
// ‚îÄ‚îÄ Firebase Setup ‚îÄ‚îÄ
const firebaseConfig = {
    apiKey: "AIzaSyBdluf4mJiRQjwRfdFSjlMsRvG5hZ2LZS0",
    authDomain: "jtrivia-416ca.firebaseapp.com",
    projectId: "jtrivia-416ca",
    storageBucket: "jtrivia-416ca.firebasestorage.app",
    messagingSenderId: "284944131484",
    appId: "1:284944131484:web:7c549e0036aaf65550d459"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

let currentUser = null;

// Firestore data (loaded on login)
let multData = {
    stats: { totalAnswered: 0, totalCorrect: 0, bestStreak: 0, roundsPlayed: 0, unlockedLevel: 1, dailyStreak: 0, lastPlayDate: null },
    problems: {},
    prizes: {},
    islandName: ''
};

// ‚îÄ‚îÄ Fun Features ‚îÄ‚îÄ

// Confetti explosion
function launchConfetti() {
    const container = document.getElementById('confetti-container');
    const colors = ['#ff6b6b', '#feca57', '#48dbfb', '#ff9ff3', '#54a0ff', '#5f27cd', '#00d2d3', '#1dd1a1'];

    for (let i = 0; i < 50; i++) {
        setTimeout(() => {
            const confetti = document.createElement('div');
            confetti.className = 'confetti';
            confetti.style.left = Math.random() * 100 + '%';
            confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
            confetti.style.borderRadius = Math.random() > 0.5 ? '50%' : '0';
            confetti.style.width = (Math.random() * 10 + 5) + 'px';
            confetti.style.height = confetti.style.width;
            confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
            container.appendChild(confetti);

            setTimeout(() => confetti.remove(), 4000);
        }, i * 30);
    }
}

// Mascot reactions
function mascotReact(isCorrect) {
    const mascot = document.getElementById('mascot');
    mascot.className = 'mascot';

    if (isCorrect) {
        mascot.textContent = 'ü•≥';
        mascot.classList.add('happy');
    } else {
        mascot.textContent = 'ü§ó';
        mascot.classList.add('sad');
    }

    setTimeout(() => {
        mascot.className = 'mascot';
        mascot.textContent = 'ü¶ù';
    }, 1500);
}

// Running character
function runCharacter() {
    const runner = document.getElementById('runner');
    runner.classList.remove('running');
    // Force reflow to restart animation
    void runner.offsetWidth;
    runner.classList.add('running');

    setTimeout(() => {
        runner.classList.remove('running');
    }, 2000);
}

// Floating sparkles background
function createSparkles() {
    const sparkleChars = ['‚ú®', '‚≠ê', 'üåü', 'üí´'];
    for (let i = 0; i < 15; i++) {
        const sparkle = document.createElement('div');
        sparkle.className = 'sparkle';
        sparkle.textContent = sparkleChars[Math.floor(Math.random() * sparkleChars.length)];
        sparkle.style.left = Math.random() * 100 + '%';
        sparkle.style.top = Math.random() * 100 + '%';
        sparkle.style.fontSize = (Math.random() * 1 + 0.5) + 'rem';
        sparkle.style.animationDelay = Math.random() * 2 + 's';
        document.body.appendChild(sparkle);
    }
}
createSparkles();

// Level up animation
function showLevelUpAnimation(level) {
    const overlay = document.createElement('div');
    overlay.className = 'level-up-overlay';
    overlay.innerHTML = `
        <div class="level-up-content">
            <span class="level-icon">${level.icon}</span>
            <div class="level-text">LEVEL UP!</div>
            <div class="level-name">${level.name} Unlocked!</div>
        </div>
    `;
    document.body.appendChild(overlay);
    playSound('fanfare');
    launchConfetti();

    setTimeout(() => {
        overlay.style.animation = 'fadeIn 0.3s ease-out reverse';
        setTimeout(() => overlay.remove(), 300);
    }, 2500);
}

// Combo multiplier
let comboCount = 0;

function updateCombo(isCorrect) {
    const comboDisplay = document.getElementById('combo-display');

    if (isCorrect) {
        comboCount++;
        if (comboCount >= 3) {
            comboDisplay.textContent = `üî• x${comboCount} Combo!`;
            comboDisplay.classList.add('active');
        }
    } else {
        comboCount = 0;
        comboDisplay.classList.remove('active');
    }
}

function getComboBonus() {
    if (comboCount >= 5) return 2;
    if (comboCount >= 3) return 1;
    return 0;
}

// Achievements/Badges
const ACHIEVEMENTS = [
    { id: 'first_perfect', name: 'Perfect Start', desc: 'Get 100% on a round', icon: 'üéØ', check: () => false },
    { id: 'streak_10', name: 'On Fire!', desc: 'Get 10 in a row', icon: 'üî•', check: () => false },
    { id: 'speed_demon', name: 'Speed Demon', desc: 'Answer 5 questions in under 10 seconds each', icon: '‚ö°', check: () => false },
    { id: 'week_warrior', name: 'Week Warrior', desc: 'Play 7 days in a row', icon: 'üìÖ', check: () => multData.stats.dailyStreak >= 7 },
    { id: 'century', name: 'Century Club', desc: 'Answer 100 questions', icon: 'üíØ', check: () => multData.stats.totalAnswered >= 100 },
    { id: 'master', name: 'Math Master', desc: 'Answer 500 questions', icon: 'üßô', check: () => multData.stats.totalAnswered >= 500 },
    { id: 'perfectionist', name: 'Perfectionist', desc: 'Get 5 perfect rounds', icon: 'üëë', check: () => false },
    { id: 'explorer', name: 'Island Explorer', desc: 'Unlock all levels', icon: 'üó∫Ô∏è', check: () => unlockedLevel >= LEVELS.length }
];

function checkAchievements() {
    if (!multData.achievements) multData.achievements = {};

    for (const ach of ACHIEVEMENTS) {
        if (!multData.achievements[ach.id] && ach.check()) {
            multData.achievements[ach.id] = true;
            showBadge(ach);
            return; // One at a time
        }
    }
}

function showBadge(achievement) {
    const popup = document.createElement('div');
    popup.className = 'badge-popup';
    popup.innerHTML = `
        <span class="badge-icon">${achievement.icon}</span>
        <div class="badge-title">${achievement.name}</div>
        <div class="badge-desc">${achievement.desc}</div>
    `;
    document.body.appendChild(popup);
    playSound('fanfare');

    setTimeout(() => {
        popup.style.animation = 'badgePop 0.3s ease-out reverse';
        setTimeout(() => popup.remove(), 300);
    }, 3000);
}

// Weather effects
function setWeather() {
    const container = document.getElementById('weather-container');
    container.innerHTML = '';

    const hour = new Date().getHours();

    if (hour >= 6 && hour < 12) {
        // Morning sunshine
        for (let i = 0; i < 8; i++) {
            const ray = document.createElement('div');
            ray.className = 'sunray';
            ray.style.left = (i * 12 + Math.random() * 10) + '%';
            ray.style.animationDelay = Math.random() * 2 + 's';
            container.appendChild(ray);
        }
    } else if (hour >= 12 && hour < 17) {
        // Afternoon - clear/sparkly (already have sparkles)
    } else if (hour >= 17 && hour < 20) {
        // Evening - light rain
        for (let i = 0; i < 30; i++) {
            const drop = document.createElement('div');
            drop.className = 'raindrop';
            drop.style.left = Math.random() * 100 + '%';
            drop.style.animationDelay = Math.random() * 1 + 's';
            drop.style.animationDuration = (Math.random() * 0.3 + 0.6) + 's';
            container.appendChild(drop);
        }
    } else {
        // Night - snow
        const snowflakes = ['‚ùÑ', '‚ùÖ', '‚ùÜ', '‚úß'];
        for (let i = 0; i < 20; i++) {
            const flake = document.createElement('div');
            flake.className = 'snowflake';
            flake.textContent = snowflakes[Math.floor(Math.random() * snowflakes.length)];
            flake.style.left = Math.random() * 100 + '%';
            flake.style.animationDelay = Math.random() * 4 + 's';
            flake.style.animationDuration = (Math.random() * 2 + 3) + 's';
            container.appendChild(flake);
        }
    }
}
setWeather();

// Double points round
let isDoublePoints = false;
const DOUBLE_POINTS_CHANCE = 0.15; // 15% chance

function checkDoublePointsRound() {
    isDoublePoints = Math.random() < DOUBLE_POINTS_CHANCE;
    if (isDoublePoints) {
        document.body.classList.add('double-points-active');
    } else {
        document.body.classList.remove('double-points-active');
    }
    return isDoublePoints;
}

// Daily streak
function updateDailyStreak() {
    const today = new Date().toISOString().split('T')[0];
    const lastPlay = multData.stats.lastPlayDate;

    if (!lastPlay) {
        multData.stats.dailyStreak = 1;
    } else if (lastPlay === today) {
        // Already played today, keep streak
    } else {
        const lastDate = new Date(lastPlay);
        const todayDate = new Date(today);
        const diffDays = Math.floor((todayDate - lastDate) / (1000 * 60 * 60 * 24));

        if (diffDays === 1) {
            multData.stats.dailyStreak++;
        } else if (diffDays > 1) {
            multData.stats.dailyStreak = 1;
        }
    }
    multData.stats.lastPlayDate = today;
    updateDailyStreakDisplay();
}

function updateDailyStreakDisplay() {
    const streak = multData.stats.dailyStreak || 0;
    let streakEl = document.getElementById('daily-streak');

    if (streak > 1) {
        if (!streakEl) {
            streakEl = document.createElement('span');
            streakEl.id = 'daily-streak';
            streakEl.className = 'daily-streak-display';
            document.querySelector('.score-bar').appendChild(streakEl);
        }
        streakEl.innerHTML = `<span class="streak-flame">üî•</span>${streak} days`;
    } else if (streakEl) {
        streakEl.remove();
    }
}

// Island name
function updateIslandName() {
    const title = document.getElementById('island-title');
    if (multData.islandName) {
        title.innerHTML = `${multData.islandName}<br>Island`;
    } else {
        title.innerHTML = `Penny's Multiplication<br>Island`;
    }
}

function showIslandNamePrompt() {
    const name = prompt("What would you like to name your island?", multData.islandName || "Penny's Multiplication");
    if (name !== null && name.trim()) {
        multData.islandName = name.trim();
        updateIslandName();
        saveMultiplicationData();
    }
}

// Sound effects (using Web Audio API for simple tones)
const audioContext = new (window.AudioContext || window.webkitAudioContext)();

function playSound(type) {
    try {
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();

        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);

        if (type === 'correct') {
            oscillator.frequency.setValueAtTime(523.25, audioContext.currentTime); // C5
            oscillator.frequency.setValueAtTime(659.25, audioContext.currentTime + 0.1); // E5
            oscillator.frequency.setValueAtTime(783.99, audioContext.currentTime + 0.2); // G5
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.4);
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.4);
        } else if (type === 'wrong') {
            oscillator.frequency.setValueAtTime(200, audioContext.currentTime);
            gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.3);
        } else if (type === 'fanfare') {
            const notes = [523.25, 659.25, 783.99, 1046.50];
            notes.forEach((freq, i) => {
                const osc = audioContext.createOscillator();
                const gain = audioContext.createGain();
                osc.connect(gain);
                gain.connect(audioContext.destination);
                osc.frequency.setValueAtTime(freq, audioContext.currentTime + i * 0.15);
                gain.gain.setValueAtTime(0.3, audioContext.currentTime + i * 0.15);
                gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + i * 0.15 + 0.3);
                osc.start(audioContext.currentTime + i * 0.15);
                osc.stop(audioContext.currentTime + i * 0.15 + 0.3);
            });
        }
    } catch(e) {
        // Audio not supported, silently fail
    }
}

// ‚îÄ‚îÄ Auth ‚îÄ‚îÄ
auth.onAuthStateChanged(async (user) => {
    currentUser = user;
    updateAuthUI();
    if (user) {
        await loadMultiplicationData();
    }
});

function updateAuthUI() {
    const statusEl = document.getElementById('user-status');
    const loginScreen = document.getElementById('login-screen');
    const gameArea = document.getElementById('game-area');

    if (currentUser) {
        statusEl.textContent = currentUser.email + ' (log out)';
        loginScreen.style.display = 'none';
        gameArea.style.display = 'block';
    } else {
        statusEl.textContent = 'Log in to save progress';
        loginScreen.style.display = 'block';
        gameArea.style.display = 'block';
    }
}

function handleUserStatusClick() {
    if (currentUser) {
        auth.signOut();
        multData = {
            stats: { totalAnswered: 0, totalCorrect: 0, bestStreak: 0, roundsPlayed: 0, unlockedLevel: 1, dailyStreak: 0, lastPlayDate: null },
            problems: {},
            prizes: {},
            islandName: ''
        };
        initDefaultPrizes();
        currentLevel = 1;
        unlockedLevel = 1;
        renderLevelSelect();
        renderPrizeButton();
        updateIslandName();
        updateDailyStreakDisplay();
    } else {
        document.getElementById('login-screen').style.display = 'block';
        document.getElementById('login-email').focus();
    }
}

async function doLogin() {
    const email = document.getElementById('login-email').value.trim();
    const password = document.getElementById('login-password').value;
    const errorEl = document.getElementById('login-error');
    errorEl.style.display = 'none';

    if (!email || !password) {
        errorEl.textContent = 'Please enter email and password.';
        errorEl.style.display = 'block';
        return;
    }

    try {
        await auth.signInWithEmailAndPassword(email, password);
    } catch (error) {
        errorEl.textContent = error.message;
        errorEl.style.display = 'block';
    }
}

// Enter key on login fields
document.getElementById('login-password').addEventListener('keydown', function(e) {
    if (e.key === 'Enter') doLogin();
});

// ‚îÄ‚îÄ Firestore Data ‚îÄ‚îÄ
async function loadMultiplicationData() {
    if (!currentUser) return;
    try {
        const doc = await db.collection('users').doc(currentUser.uid).get();
        if (doc.exists && doc.data().multiplication) {
            const m = doc.data().multiplication;
            multData.stats = m.stats || multData.stats;
            multData.problems = m.problems || {};
            // Merge saved prizes with defaults (preserves new milestones)
            if (m.prizes) {
                for (const key of Object.keys(m.prizes)) {
                    multData.prizes[key] = m.prizes[key];
                }
            }
            initDefaultPrizes();
            if (m.islandName) {
                multData.islandName = m.islandName;
                updateIslandName();
            }
            if (multData.stats.unlockedLevel) {
                unlockedLevel = multData.stats.unlockedLevel;
                if (currentLevel > unlockedLevel) currentLevel = unlockedLevel;
                renderLevelSelect();
            }
            renderPrizeButton();
            updateDailyStreakDisplay();
        }
    } catch (e) {
        console.log('Could not load multiplication data:', e);
    }
}

async function saveMultiplicationData() {
    if (!currentUser) return;
    try {
        await db.collection('users').doc(currentUser.uid).set({
            multiplication: multData
        }, { merge: true });
    } catch (e) {
        console.log('Could not save multiplication data:', e);
    }
}

// ‚îÄ‚îÄ Island Places (unlock every 20 correct) ‚îÄ‚îÄ
const ISLAND_PLACES = [
    { name: "Nook's Cranny", icon: "üè™", desc: "Tom Nook's shop is open for business!" },
    { name: "The Museum", icon: "üèõÔ∏è", desc: "Blathers can't wait to see your collection!" },
    { name: "Able Sisters", icon: "üßµ", desc: "Mabel and Sable have clothes for you!" },
    { name: "Resident Services", icon: "üè¢", desc: "Isabelle is ready to help!" },
    { name: "The Campsite", icon: "‚õ∫", desc: "Visitors are coming to your island!" },
    { name: "Starfall Cliff", icon: "üå†", desc: "A magical place where stars fall!" },
    { name: "Rainbow Falls", icon: "üåà", desc: "The most colorful waterfall on the island!" },
    { name: "Mushroom Grove", icon: "üçÑ", desc: "Giant mushrooms grow here year-round!" },
    { name: "Fossil Canyon", icon: "ü¶¥", desc: "Ancient treasures hide in these rocks!" },
    { name: "Butterfly Garden", icon: "ü¶ã", desc: "Flick's favorite place to visit!" },
    { name: "Crystal Cave", icon: "üíé", desc: "Glittering gems light up the darkness!" },
    { name: "Cloud Overlook", icon: "‚òÅÔ∏è", desc: "Touch the clouds from up here!" },
    { name: "Honeybee Meadow", icon: "üêù", desc: "Sweet honey flows from golden hives!" },
    { name: "Firefly Lake", icon: "‚ú®", desc: "Glowing fireflies dance at night!" },
    { name: "K.K. Concert Hall", icon: "üé∏", desc: "K.K. Slider plays here every night!" },
    { name: "Treasure Cove", icon: "üè¥‚Äç‚ò†Ô∏è", desc: "Gulliver found pirate gold here!" },
    { name: "Northern Lights Peak", icon: "üåå", desc: "The aurora shines above the mountain!" },
    { name: "Sakura Springs", icon: "üå∏", desc: "Cherry blossoms bloom forever here!" },
    { name: "Mermaid Lagoon", icon: "üßú‚Äç‚ôÄÔ∏è", desc: "Pascal shares secrets in these waters!" },
    { name: "Golden Palace", icon: "üëë", desc: "The ultimate island achievement!" }
];

function getUnlockedPlaces() {
    const totalCorrect = multData.stats.totalCorrect || 0;
    return Math.min(Math.floor(totalCorrect / 20), ISLAND_PLACES.length);
}

function checkNewPlaceUnlocked(prevCorrect, newCorrect) {
    const prevPlaces = Math.floor(prevCorrect / 20);
    const newPlaces = Math.floor(newCorrect / 20);
    if (newPlaces > prevPlaces && newPlaces <= ISLAND_PLACES.length) {
        return ISLAND_PLACES[newPlaces - 1];
    }
    return null;
}

// ‚îÄ‚îÄ Prize Milestones ‚îÄ‚îÄ
const PRIZE_MILESTONES = [50, 100, 200, 350, 500, 750, 1000];

function initDefaultPrizes() {
    if (!multData.prizes) multData.prizes = {};
    for (const m of PRIZE_MILESTONES) {
        if (!multData.prizes[m]) {
            multData.prizes[m] = { name: "", earned: false };
        }
    }
}
initDefaultPrizes();

// ‚îÄ‚îÄ Levels ‚îÄ‚îÄ
const LEVELS = [
    { num: 1, name: "Beach", icon: "üèñÔ∏è", factors: [5, 10] },
    { num: 2, name: "Meadow", icon: "üåª", factors: [2, 4, 11] },
    { num: 3, name: "Forest", icon: "üå≤", factors: [3, 6, 9] },
    { num: 4, name: "Volcano", icon: "üåã", factors: [7, 8, 12] },
    { num: 5, name: "Orchard", icon: "üçé", factors: [2, 3, 4, 5] },
    { num: 6, name: "Campsite", icon: "üèïÔ∏è", factors: [6, 7, 8] },
    { num: 7, name: "Snowfield", icon: "‚ùÑÔ∏è", factors: [9, 11, 12] },
    { num: 8, name: "Champion Island", icon: "üèÜ", factors: [2,3,4,5,6,7,8,9,10,11,12] },
];
const UNLOCK_THRESHOLD = 0.8; // 80% to unlock next level

let currentLevel = 1;
let unlockedLevel = 1;

// ‚îÄ‚îÄ Quiz State ‚îÄ‚îÄ
const TIMES_ROUND = 20;
const BREAKDOWN_ROUND = 10;

function renderLevelSelect() {
    const container = document.getElementById('level-select');
    // Only show for times tables mode
    if (currentMode !== 'times' || practiceViewActive) {
        container.style.display = 'none';
        return;
    }
    container.style.display = 'flex';
    container.innerHTML = LEVELS.map(lv => {
        const isLocked = lv.num > unlockedLevel;
        const isActive = lv.num === currentLevel;
        let cls = 'level-btn';
        if (isActive) cls += ' active';
        if (isLocked) cls += ' locked';
        const lockIcon = isLocked ? 'üîí ' : '';
        return `<button class="${cls}" onclick="selectLevel(${lv.num})" ${isLocked ? 'disabled' : ''}>
            <span class="level-icon">${lv.icon}</span>${lockIcon}${lv.name}
        </button>`;
    }).join('');
}

function selectLevel(num) {
    if (num > unlockedLevel) return;
    currentLevel = num;
    renderLevelSelect();
    startRound();
}

const correctMessages = [
    "Tom Nook is impressed!",
    "You earned some Nook Miles!",
    "Isabelle is cheering for you!",
    "Your island rating just went up!",
    "K.K. Slider wrote a song about that answer!",
    "Blathers would be proud!",
    "That's worth a golden shovel!",
    "You found a rare fossil... of knowledge!",
    "Celeste saw that in the stars!",
    "Perfect, like a blue rose!",
    "Daisy Mae is doing a happy dance!",
    "You just caught a rare bug... a Math Moth!",
    "Nook's Cranny wants to hire you!",
    "Your villagers are throwing a party!",
    "That answer belongs in the museum!",
    "Flick would pay double for that answer!",
    "You're a five-star islander!",
    "Pascal would share his scallop with you!",
    "Leif is planting flowers in your honor!",
    "CJ wants to make a model of that answer!",
    "Brewster made you a special coffee!",
    "Kicks is giving you a standing ovation!",
    "Saharah rolled out the red carpet!",
    "Timmy and Tommy are applauding!",
    "Redd says that's a genuine masterpiece!",
    "Kapp'n is singing a song about you!",
    "You found a golden nugget of wisdom!",
    "Label wants to design an outfit for you!",
    "Gracie would give that an A+!",
    "You're getting a letter from Mom!",
    "Zipper is hopping with joy!",
    "Orville is announcing your greatness!",
    "That's worth a million bells!",
    "Harriet is styling your victory hair!",
    "Digby is taking notes on your skills!",
    "Luna is saving that answer in a dream!",
    "Lottie is decorating in your honor!",
    "Wardell nods in silent approval!",
    "Tortimer would be proud!",
    "You just unlocked island paradise!"
];

const wrongMessages = [
    "Even Gulliver gets lost sometimes!",
    "Wisp dropped a spirit piece...",
    "Oops! Try again next time!",
    "That bell bag was just slightly off!",
    "Almost had it, villager!",
    "Keep digging, you'll find the fossil!"
];

const streakMessages = [
    "You're on a Nook Miles+ streak!",
    "Unstoppable island explorer!",
    "The villagers are amazed!",
    "Tom Nook wants to give you a raise!",
    "Legendary islander status!"
];

let currentMode = 'times';
let score = 0;
let total = 0;
let streak = 0;
let bestStreak = 0;
let answered = false;
let roundLength = TIMES_ROUND;
let practiceViewActive = false;

// Break It Down state
let bdA = 0;
let bdB = 0;
let bdTens = 0;
let bdOnes = 0;
let bdStep = 0;

// Current problem tracking for the round
let currentProblemA = 0;
let currentProblemB = 0;
let roundProblems = []; // { key, correct } for each answered problem in this round

function pickRandom(arr) {
    return arr[Math.floor(Math.random() * arr.length)];
}

function randInt(min, max) {
    return Math.floor(Math.random() * (max - min + 1)) + min;
}

function problemKey(a, b) {
    // Normalize so 3x7 and 7x3 are same key (smaller first)
    const lo = Math.min(a, b);
    const hi = Math.max(a, b);
    return lo + 'x' + hi;
}

function setMode(mode, btn) {
    practiceViewActive = false;
    currentMode = mode;
    document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    roundLength = mode === 'times' ? TIMES_ROUND : BREAKDOWN_ROUND;
    document.getElementById('qtotal').textContent = roundLength;
    document.querySelector('.score-bar').style.display = '';
    renderLevelSelect();
    startRound();
}

function startRound() {
    practiceViewActive = false;
    score = 0;
    total = 0;
    streak = 0;
    bestStreak = 0;
    roundProblems = [];
    document.querySelector('.score-bar').style.display = '';

    // Check for mystery double points round
    checkDoublePointsRound();

    updateScoreboard();
    renderPrizeButton();
    updateDailyStreakDisplay();
    nextQuestion();
}

function updateScoreboard() {
    document.getElementById('score').textContent = score;
    document.getElementById('streak').textContent = streak;
    document.getElementById('qnum').textContent = Math.min(total + 1, roundLength);
}

function rebuildCard() {
    const card = document.getElementById('card');
    const doublePointsBadge = isDoublePoints ? '<div class="double-points-badge">‚≠ê Double Points Round! ‚≠ê</div>' : '';
    card.innerHTML = `
        ${doublePointsBadge}
        <div class="question-label" id="q-label"></div>
        <div class="question-text" id="q-text"></div>
        <div id="extra"></div>
        <div class="answer-area" id="answer-area">
            <input type="number" class="answer-input" id="answer-input" autocomplete="off">
            <button class="submit-btn" id="submit-btn" onclick="submitAnswer()">Go!</button>
        </div>
        <div class="feedback" id="feedback"></div>
        <button class="next-btn" id="next-btn" onclick="nextQuestion()">Next Question</button>
    `;
}

function focusInput() {
    const inp = document.getElementById('answer-input');
    if (inp) {
        inp.value = '';
        inp.className = 'answer-input';
        inp.disabled = false;
        inp.focus();
    }
}

function showRoundEnd() {
    const pct = Math.round((score / roundLength) * 100);
    let msg, emoji;
    if (pct === 100) { msg = "Perfect score! You're the island champion!"; emoji = "üèÜ"; }
    else if (pct >= 90) { msg = "Tom Nook is giving you a bonus!"; emoji = "üåü"; }
    else if (pct >= 70) { msg = "Your island rating just hit 5 stars!"; emoji = "üçÉ"; }
    else if (pct >= 50) { msg = "Great work, keep exploring!"; emoji = "üå±"; }
    else { msg = "Every islander starts somewhere! Try again!"; emoji = "üí™"; }

    // Confetti for great scores!
    if (pct >= 90) {
        launchConfetti();
        playSound('fanfare');
    }

    // Update daily streak
    updateDailyStreak();

    // Clear double points mode
    document.body.classList.remove('double-points-active');
    isDoublePoints = false;

    // Track round stats
    if (bestStreak > multData.stats.bestStreak) {
        multData.stats.bestStreak = bestStreak;
    }
    multData.stats.roundsPlayed++;

    // Remember previous correct count for place unlock check
    const prevCorrect = multData.stats.totalCorrect || 0;

    // Update problem-level data
    const today = new Date().toISOString().split('T')[0];
    for (const rp of roundProblems) {
        if (!multData.problems[rp.key]) {
            multData.problems[rp.key] = { attempts: 0, correct: 0, lastSeen: today };
        }
        multData.problems[rp.key].attempts++;
        if (rp.correct) multData.problems[rp.key].correct++;
        multData.problems[rp.key].lastSeen = today;

        multData.stats.totalAnswered++;
        if (rp.correct) multData.stats.totalCorrect++;
    }

    // Reset combo
    comboCount = 0;
    document.getElementById('combo-display').classList.remove('active');

    // Check for level unlock
    let unlockHTML = '';
    let levelUpLevel = null;
    if (currentMode === 'times'
        && score / roundLength >= UNLOCK_THRESHOLD
        && currentLevel === unlockedLevel
        && unlockedLevel < LEVELS.length) {
        unlockedLevel++;
        multData.stats.unlockedLevel = unlockedLevel;
        levelUpLevel = LEVELS[unlockedLevel - 1];
        unlockHTML = `
            <div class="unlock-msg">
                <span class="unlock-icon">${levelUpLevel.icon}</span>
                <div class="unlock-title">Level Unlocked!</div>
                <div class="unlock-detail">${levelUpLevel.name} is now open!</div>
            </div>
        `;
    }

    // Check for prize milestones
    const newlyEarnedPrizes = checkPrizeEarned();

    // Check for new island place unlock
    const newPlace = checkNewPlaceUnlocked(prevCorrect, multData.stats.totalCorrect);

    // Save to Firestore (batch at end of round)
    saveMultiplicationData();

    // Show level up animation if unlocked
    if (levelUpLevel) {
        setTimeout(() => showLevelUpAnimation(levelUpLevel), 500);
    }

    // Check for achievements
    setTimeout(() => checkAchievements(), levelUpLevel ? 3500 : 1000);

    // Build place unlock celebration HTML
    let placeHTML = '';
    if (newPlace) {
        launchConfetti();
        playSound('fanfare');
        placeHTML = `
            <div class="place-unlock-msg">
                <span class="place-icon">${newPlace.icon}</span>
                <div class="place-title">New Place Discovered!</div>
                <div class="place-name">${newPlace.name}</div>
                <div class="place-desc">${newPlace.desc}</div>
                <div class="place-stars">üåü üåü üåü</div>
            </div>
        `;
    }

    // Build prize earned celebration HTML
    let prizeHTML = '';
    for (const m of newlyEarnedPrizes) {
        const prizeName = multData.prizes[m].name || 'a mystery prize';
        prizeHTML += `
            <div class="prize-earned-msg">
                <span class="prize-earned-icon">üèÜ</span>
                <div class="prize-earned-title">Prize Earned!</div>
                <div class="prize-earned-detail">${prizeName} ‚Äî Ask your parent!</div>
            </div>
        `;
    }

    // Build missed problems list from this round
    const missed = roundProblems.filter(rp => !rp.correct);
    let missedHTML = '';
    if (missed.length > 0) {
        const tags = missed.map(rp => `<span class="round-missed-tag">${rp.key.replace('x', ' √ó ')}</span>`).join('');
        missedHTML = `
            <div class="round-missed">
                <h4>Practice these next time:</h4>
                <div class="round-missed-list">${tags}</div>
            </div>
        `;
    }

    // All-time stats line
    let alltimeHTML = '';
    if (currentUser && multData.stats.totalAnswered > 0) {
        alltimeHTML = `<div class="alltime-stats">
            You've answered ${multData.stats.totalAnswered} questions on the island!
            (${multData.stats.totalCorrect} correct, best streak: ${multData.stats.bestStreak})
        </div>`;
    }

    // Emoji applause crowd
    const applauseEmojis = ['üëè', 'üéâ', 'üòÑ', 'ü•≥', 'üëè', 'üåü', 'üòä', 'üéä', 'üëè'];
    const applauseHTML = `
        <div class="applause-crowd">
            ${applauseEmojis.map(e => `<span>${e}</span>`).join('')}
        </div>
    `;

    const card = document.getElementById('card');
    card.innerHTML = `
        <div class="round-end">
            <h2>${emoji} Round Complete!</h2>
            ${applauseHTML}
            <div class="final-score">${score}/${roundLength}</div>
            <div class="final-msg">${msg}</div>
            <div class="final-details">Best streak this round: ${bestStreak}</div>
            ${unlockHTML}
            ${placeHTML}
            ${prizeHTML}
            ${missedHTML}
            ${alltimeHTML}
            <button class="play-again-btn" onclick="startRound()">Play Again</button>
        </div>
    `;
    document.getElementById('streak-msg').textContent = '';
    renderLevelSelect();
    renderPrizeButton();
}

// ‚îÄ‚îÄ Times Tables Mode ‚îÄ‚îÄ

function nextTimesQuestion() {
    rebuildCard();
    answered = false;
    const level = LEVELS[currentLevel - 1];
    const focusFactor = pickRandom(level.factors);
    const otherFactor = randInt(2, 12);
    // Randomly swap so the focus factor isn't always on the left
    const a = Math.random() < 0.5 ? focusFactor : otherFactor;
    const b = a === focusFactor ? otherFactor : focusFactor;
    currentProblemA = a;
    currentProblemB = b;
    const answer = a * b;

    document.getElementById('q-label').textContent = `Level ${level.num} ‚Äî ${level.name} ${level.icon}`;
    document.getElementById('q-text').innerHTML = `<span class="highlight">${a}</span> &times; <span class="highlight">${b}</span> = ?`;
    document.getElementById('answer-input').dataset.answer = answer;

    updateScoreboard();
    focusInput();
}

// ‚îÄ‚îÄ Break It Down Mode ‚îÄ‚îÄ

function nextBreakdownQuestion() {
    rebuildCard();
    answered = false;

    bdA = randInt(13, 19);
    bdB = randInt(2, 12);
    bdTens = 10;
    bdOnes = bdA - 10;
    bdStep = 0;
    currentProblemA = bdA;
    currentProblemB = bdB;

    document.getElementById('q-label').textContent = 'Break It Down';

    showBreakdownStep();
    updateScoreboard();
    focusInput();
}

function showBreakdownStep() {
    const extra = document.getElementById('extra');
    const qText = document.getElementById('q-text');
    const inp = document.getElementById('answer-input');

    extra.innerHTML = `
        <div class="step-tracker">
            <div class="step-dot ${bdStep === 0 ? 'active' : (bdStep > 0 ? 'done' : '')}"></div>
            <div class="step-dot ${bdStep === 1 ? 'active' : (bdStep > 1 ? 'done' : '')}"></div>
            <div class="step-dot ${bdStep === 2 ? 'active' : ''}"></div>
        </div>
        <div class="breakdown-hint">Breaking down ${bdA} &times; ${bdB} into (${bdTens} + ${bdOnes}) &times; ${bdB}</div>
    `;

    if (bdStep === 0) {
        qText.innerHTML = `Step 1: <span class="highlight">${bdTens}</span> &times; <span class="highlight">${bdB}</span> = ?`;
        inp.dataset.answer = bdTens * bdB;
    } else if (bdStep === 1) {
        qText.innerHTML = `Step 2: <span class="highlight">${bdOnes}</span> &times; <span class="highlight">${bdB}</span> = ?`;
        inp.dataset.answer = bdOnes * bdB;
    } else {
        qText.innerHTML = `Final: <span class="highlight">${bdA}</span> &times; <span class="highlight">${bdB}</span> = ?`;
        inp.dataset.answer = bdA * bdB;

        extra.innerHTML = `
            <div class="step-tracker">
                <div class="step-dot done"></div>
                <div class="step-dot done"></div>
                <div class="step-dot active"></div>
            </div>
            <div class="breakdown-hint">${bdTens * bdB} + ${bdOnes * bdB} = ?</div>
        `;
    }
}

// ‚îÄ‚îÄ Keep Practicing View ‚îÄ‚îÄ

function showPracticeView() {
    practiceViewActive = true;
    document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
    document.getElementById('btn-practice').classList.add('active');
    document.querySelector('.score-bar').style.display = 'none';
    document.getElementById('streak-msg').textContent = '';
    renderLevelSelect();

    const card = document.getElementById('card');

    // Get problems sorted by lowest accuracy
    const entries = Object.entries(multData.problems);

    if (!currentUser) {
        card.innerHTML = `
            <div class="practice-view">
                <div class="practice-empty">
                    <span class="practice-empty-icon">üèùÔ∏è</span>
                    Log in to track your progress!
                </div>
                <button class="back-btn" onclick="setMode('times', document.getElementById('btn-times'))">Back to Times Tables</button>
            </div>
        `;
        return;
    }

    if (entries.length === 0) {
        card.innerHTML = `
            <div class="practice-view">
                <div class="practice-empty">
                    <span class="practice-empty-icon">üå¥</span>
                    Play some rounds first!<br>
                    Your practice data will show up here.
                </div>
                <button class="back-btn" onclick="setMode('times', document.getElementById('btn-times'))">Back to Times Tables</button>
            </div>
        `;
        return;
    }

    // Sort by accuracy ascending (worst first), only include problems with at least 1 wrong
    const needsPractice = entries
        .map(([key, data]) => ({
            key,
            attempts: data.attempts,
            correct: data.correct,
            accuracy: data.attempts > 0 ? data.correct / data.attempts : 0
        }))
        .filter(p => p.accuracy < 1)
        .sort((a, b) => a.accuracy - b.accuracy)
        .slice(0, 10);

    if (needsPractice.length === 0) {
        card.innerHTML = `
            <div class="practice-view">
                <div class="practice-empty">
                    <span class="practice-empty-icon">üåü</span>
                    Amazing! You've got them all right!<br>
                    Keep playing to stay sharp!
                </div>
                <button class="back-btn" onclick="setMode('times', document.getElementById('btn-times'))">Back to Times Tables</button>
            </div>
        `;
        return;
    }

    let itemsHTML = '';
    for (const p of needsPractice) {
        const pctNum = Math.round(p.accuracy * 100);
        itemsHTML += `
            <div class="practice-item">
                <div class="practice-problem">${p.key.replace('x', ' √ó ')}</div>
                <div class="practice-bar-wrap">
                    <div class="practice-bar-fill" style="width: ${pctNum}%"></div>
                </div>
                <div class="practice-pct">${pctNum}%</div>
            </div>
        `;
    }

    // Store problems for practice mode
    window.practiceProblems = needsPractice.map(p => p.key);

    card.innerHTML = `
        <div class="practice-view">
            <h3>These ones are almost there!</h3>
            <div class="practice-subtitle">Keep going ‚Äî you're getting closer!</div>
            ${itemsHTML}
            <button class="play-again-btn" onclick="startPracticeRound()" style="margin-top: 1rem;">Practice These Now</button>
            <button class="back-btn" onclick="setMode('times', document.getElementById('btn-times'))">Back to Times Tables</button>
        </div>
    `;
}

// Practice mode - drill specific problems
let isPracticeMode = false;
let practiceQueue = [];

function startPracticeRound() {
    isPracticeMode = true;
    practiceViewActive = false;
    practiceQueue = [...window.practiceProblems];

    // Shuffle the practice queue
    for (let i = practiceQueue.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [practiceQueue[i], practiceQueue[j]] = [practiceQueue[j], practiceQueue[i]];
    }

    score = 0;
    total = 0;
    streak = 0;
    bestStreak = 0;
    roundProblems = [];
    roundLength = Math.min(practiceQueue.length, 10);

    document.getElementById('qtotal').textContent = roundLength;
    document.querySelector('.score-bar').style.display = '';
    document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
    document.getElementById('btn-practice').classList.add('active');

    updateScoreboard();
    nextPracticeQuestion();
}

function nextPracticeQuestion() {
    if (total >= roundLength) {
        isPracticeMode = false;
        showRoundEnd();
        return;
    }

    rebuildCard();
    answered = false;

    const problemKey = practiceQueue[total];
    const [a, b] = problemKey.split('x').map(Number);
    currentProblemA = a;
    currentProblemB = b;
    const answer = a * b;

    document.getElementById('q-label').textContent = 'Practice Mode üéØ';
    document.getElementById('q-text').innerHTML = `<span class="highlight">${a}</span> &times; <span class="highlight">${b}</span> = ?`;
    document.getElementById('answer-input').dataset.answer = answer;

    updateScoreboard();
    focusInput();
}

// ‚îÄ‚îÄ Shared Logic ‚îÄ‚îÄ

function nextQuestion() {
    if (total >= roundLength) {
        isPracticeMode = false;
        showRoundEnd();
        return;
    }
    if (isPracticeMode) {
        nextPracticeQuestion();
    } else if (currentMode === 'times') {
        nextTimesQuestion();
    } else {
        nextBreakdownQuestion();
    }
}

function submitAnswer() {
    if (answered) return;
    const inp = document.getElementById('answer-input');
    const userAnswer = inp.value.trim();
    if (userAnswer === '') return;

    const correct = parseInt(inp.dataset.answer);
    const isCorrect = parseInt(userAnswer) === correct;

    // In breakdown mode, handle steps
    if (currentMode === 'breakdown' && bdStep < 2) {
        if (isCorrect) {
            inp.classList.add('correct');
            bdStep++;
            setTimeout(() => {
                inp.value = '';
                inp.className = 'answer-input';
                showBreakdownStep();
                inp.focus();
            }, 600);
        } else {
            inp.classList.add('wrong');
            const feedback = document.getElementById('feedback');
            feedback.className = 'feedback wrong';
            feedback.textContent = `The answer is ${correct}. Let's keep going!`;
            bdStep++;
            setTimeout(() => {
                feedback.className = 'feedback';
                feedback.style.display = 'none';
                inp.value = '';
                inp.className = 'answer-input';
                showBreakdownStep();
                inp.focus();
            }, 1500);
        }
        return;
    }

    // Final answer (times tables or breakdown final step)
    answered = true;
    total++;
    inp.disabled = true;

    const feedback = document.getElementById('feedback');

    if (isCorrect) {
        const comboBonus = getComboBonus();
        score += (isDoublePoints ? 2 : 1) + comboBonus;
        streak++;
        if (streak > bestStreak) bestStreak = streak;
        inp.classList.add('correct');
        feedback.className = 'feedback correct';
        playSound('correct');
        mascotReact(true);
        runCharacter();
        updateCombo(true);
        feedback.innerHTML = pickRandom(correctMessages);
    } else {
        streak = 0;
        inp.classList.add('wrong');
        feedback.className = 'feedback wrong';
        feedback.innerHTML = `${pickRandom(wrongMessages)} The answer was <strong>${correct}</strong>.`;
        playSound('wrong');
        mascotReact(false);
        updateCombo(false);
    }

    // Record problem for this round
    const key = problemKey(currentProblemA, currentProblemB);
    roundProblems.push({ key, correct: isCorrect });

    updateScoreboard();

    const nextBtn = document.getElementById('next-btn');
    nextBtn.style.display = 'block';
    nextBtn.textContent = total >= roundLength ? 'See Results üéâ' : 'Next Question';

    if (streak >= 5) {
        document.getElementById('streak-msg').textContent = `üî• ${streak} in a row! ${pickRandom(streakMessages)}`;
    } else if (streak >= 3) {
        document.getElementById('streak-msg').textContent = `‚ú® ${streak} in a row! Nice!`;
    } else {
        document.getElementById('streak-msg').textContent = '';
    }
}

// Enter key submits
document.addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
        // Don't intercept Enter on login fields
        if (document.activeElement && document.activeElement.id === 'login-email') {
            document.getElementById('login-password').focus();
            return;
        }
        if (document.activeElement && document.activeElement.id === 'login-password') {
            doLogin();
            return;
        }
        if (practiceViewActive) return;

        const nextBtn = document.getElementById('next-btn');
        if (nextBtn && nextBtn.style.display === 'block') {
            nextQuestion();
        } else {
            submitAnswer();
        }
    }
});

// ‚îÄ‚îÄ Prize Tracker ‚îÄ‚îÄ

function getNextMilestone() {
    const total = multData.stats.totalAnswered;
    for (const m of PRIZE_MILESTONES) {
        if (total < m) return m;
    }
    return null; // all milestones earned
}

function renderPrizeButton() {
    const btn = document.getElementById('prize-tracker-btn');
    const total = multData.stats.totalAnswered;
    const next = getNextMilestone();

    if (next === null) {
        // All milestones earned
        btn.style.display = 'flex';
        document.getElementById('prize-progress-text').textContent = 'All prizes earned!';
        document.getElementById('prize-mini-fill').style.width = '100%';
    } else {
        btn.style.display = 'flex';
        document.getElementById('prize-progress-text').textContent = `${total}/${next}`;
        // Find the previous milestone to calculate segment progress
        const idx = PRIZE_MILESTONES.indexOf(next);
        const prevMilestone = idx > 0 ? PRIZE_MILESTONES[idx - 1] : 0;
        const segmentProgress = ((total - prevMilestone) / (next - prevMilestone)) * 100;
        document.getElementById('prize-mini-fill').style.width = Math.min(segmentProgress, 100) + '%';
    }
}

function showPrizeView() {
    practiceViewActive = true;
    document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
    document.querySelector('.score-bar').style.display = 'none';
    document.getElementById('streak-msg').textContent = '';
    renderLevelSelect();

    const card = document.getElementById('card');
    const total = multData.stats.totalAnswered;
    const next = getNextMilestone();

    // Build progress bar for next milestone
    let progressHTML = '';
    if (next !== null) {
        const idx = PRIZE_MILESTONES.indexOf(next);
        const prevMilestone = idx > 0 ? PRIZE_MILESTONES[idx - 1] : 0;
        const segmentProgress = ((total - prevMilestone) / (next - prevMilestone)) * 100;
        progressHTML = `
            <div class="prize-progress-bar">
                <div class="prize-progress-fill" style="width:${Math.min(segmentProgress, 100)}%"></div>
                <div class="prize-progress-label">${total} / ${next} questions</div>
            </div>
        `;
    } else {
        progressHTML = `
            <div class="prize-progress-bar">
                <div class="prize-progress-fill" style="width:100%"></div>
                <div class="prize-progress-label">All milestones complete!</div>
            </div>
        `;
    }

    // Build milestone list
    let milestonesHTML = '';
    for (const m of PRIZE_MILESTONES) {
        const prize = multData.prizes[m];
        const isEarned = prize.earned || total >= m;
        const isNext = m === next;
        const prizeName = prize.name || '???';

        let cls = 'prize-item';
        let icon = '';

        if (isEarned) {
            cls += ' earned';
            icon = '‚úÖ';
        } else if (isNext) {
            cls += ' next-up';
            icon = 'üéØ';
        } else {
            cls += ' future';
            icon = 'üîí';
        }

        milestonesHTML += `
            <div class="${cls}">
                <div class="prize-item-icon">${icon}</div>
                <div class="prize-item-info">
                    <div class="prize-item-milestone">${m} questions</div>
                    <div class="prize-item-name">${prizeName}</div>
                </div>
            </div>
        `;
    }

    // Edit link (only when logged in)
    let editHTML = '';
    if (currentUser) {
        editHTML = `<div class="prize-edit-link" onclick="showPrizeEdit()">Edit Prizes</div>`;
    }

    card.innerHTML = `
        <div class="prize-view">
            <h3>üèÜ Prize Progress</h3>
            <div class="prize-subtitle">${total} total questions answered</div>
            ${progressHTML}
            ${milestonesHTML}
            ${editHTML}
            <button class="back-btn" onclick="setMode('times', document.getElementById('btn-times'))">Back to Times Tables</button>
        </div>
    `;
}

function showPrizeEdit() {
    const card = document.getElementById('card');
    let editRowsHTML = '';
    for (const m of PRIZE_MILESTONES) {
        const prize = multData.prizes[m];
        editRowsHTML += `
            <div class="prize-edit-row">
                <div class="prize-edit-label">${m}</div>
                <input type="text" class="prize-edit-input" id="prize-input-${m}" value="${prize.name}" placeholder="Enter prize name..." maxlength="80">
            </div>
        `;
    }

    card.innerHTML = `
        <div class="prize-view">
            <h3>üèÜ Edit Prizes</h3>
            <div class="prize-subtitle">Set a prize for each milestone</div>
            ${editRowsHTML}
            <button class="prize-save-btn" onclick="savePrizeNames()">Save Prizes</button>
            <button class="back-btn" onclick="showPrizeView()">Cancel</button>
        </div>
    `;

    // Focus first input
    const firstInput = document.getElementById('prize-input-' + PRIZE_MILESTONES[0]);
    if (firstInput) firstInput.focus();
}

function savePrizeNames() {
    for (const m of PRIZE_MILESTONES) {
        const input = document.getElementById('prize-input-' + m);
        if (input) {
            multData.prizes[m].name = input.value.trim();
        }
    }
    saveMultiplicationData();
    showPrizeView();
}

function checkPrizeEarned() {
    const total = multData.stats.totalAnswered;
    const newlyEarned = [];
    for (const m of PRIZE_MILESTONES) {
        if (total >= m && !multData.prizes[m].earned) {
            multData.prizes[m].earned = true;
            newlyEarned.push(m);
        }
    }
    return newlyEarned;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NEW FEATURES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// ‚îÄ‚îÄ Difficulty Modes ‚îÄ‚îÄ
let currentDifficulty = 'normal'; // easy, normal, hard

function setDifficulty(mode) {
    currentDifficulty = mode;
    document.querySelectorAll('.difficulty-btn').forEach(b => b.classList.remove('active'));
    document.querySelector(`.difficulty-btn.${mode}`)?.classList.add('active');

    // Adjust round length based on difficulty
    if (mode === 'easy') {
        roundLength = 10;
    } else if (mode === 'hard') {
        roundLength = 30;
    } else {
        roundLength = currentMode === 'times' ? TIMES_ROUND : BREAKDOWN_ROUND;
    }
    document.getElementById('qtotal').textContent = roundLength;
}

function renderDifficultySelect() {
    let container = document.getElementById('difficulty-select');
    if (!container) {
        container = document.createElement('div');
        container.id = 'difficulty-select';
        container.className = 'difficulty-select';
        const scoreBar = document.querySelector('.score-bar');
        scoreBar.parentNode.insertBefore(container, scoreBar.nextSibling);
    }
    container.innerHTML = `
        <button class="difficulty-btn easy ${currentDifficulty === 'easy' ? 'active' : ''}" onclick="setDifficulty('easy')">üå± Easy</button>
        <button class="difficulty-btn ${currentDifficulty === 'normal' ? 'active' : ''}" onclick="setDifficulty('normal')">üåø Normal</button>
        <button class="difficulty-btn hard ${currentDifficulty === 'hard' ? 'active' : ''}" onclick="setDifficulty('hard')">üåã Hard</button>
    `;
}

// ‚îÄ‚îÄ Power-ups ‚îÄ‚îÄ
let powerups = { skip: 3, hint: 3 };

function usePowerup(type) {
    if (powerups[type] <= 0 || answered) return;

    powerups[type]--;
    renderPowerupsBar();

    if (type === 'skip') {
        // Skip this question (no penalty)
        total++;
        if (total >= roundLength) {
            showRoundEnd();
        } else {
            nextQuestion();
        }
    } else if (type === 'hint') {
        // Show a hint
        const inp = document.getElementById('answer-input');
        const answer = parseInt(inp.dataset.answer);
        const hint = Math.floor(answer / 10) * 10;
        const feedback = document.getElementById('feedback');
        feedback.className = 'feedback correct';
        feedback.style.display = 'block';
        feedback.textContent = `Hint: The answer is between ${hint} and ${hint + 10}!`;
    }
}

function renderPowerupsBar() {
    let container = document.getElementById('powerups-bar');
    if (!container) {
        container = document.createElement('div');
        container.id = 'powerups-bar';
        container.className = 'powerups-bar';
        const card = document.getElementById('card');
        card.parentNode.insertBefore(container, card);
    }
    container.innerHTML = `
        <button class="powerup-btn" onclick="usePowerup('skip')" ${powerups.skip <= 0 ? 'disabled' : ''}>
            ‚è≠Ô∏è Skip <span class="powerup-count">${powerups.skip}</span>
        </button>
        <button class="powerup-btn" onclick="usePowerup('hint')" ${powerups.hint <= 0 ? 'disabled' : ''}>
            üí° Hint <span class="powerup-count">${powerups.hint}</span>
        </button>
    `;
}

// ‚îÄ‚îÄ Collectibles ‚îÄ‚îÄ
let collectibles = { shells: 0, bugs: 0, fish: 0 };
const COLLECTIBLE_TYPES = [
    { type: 'shells', icon: 'üêö', name: 'Shell' },
    { type: 'bugs', icon: 'ü¶ã', name: 'Bug' },
    { type: 'fish', icon: 'üêü', name: 'Fish' }
];

function maybeCollectItem() {
    // 20% chance to find a collectible on correct answer
    if (Math.random() < 0.2) {
        const item = pickRandom(COLLECTIBLE_TYPES);
        collectibles[item.type]++;
        showCollectiblePopup(item);
        renderCollectiblesBar();
        saveCollectibles();
    }
}

function showCollectiblePopup(item) {
    const popup = document.createElement('div');
    popup.className = 'collectible-popup';
    popup.textContent = item.icon;
    document.body.appendChild(popup);

    setTimeout(() => popup.remove(), 1000);
}

function renderCollectiblesBar() {
    let container = document.getElementById('collectibles-bar');
    if (!container) {
        container = document.createElement('div');
        container.id = 'collectibles-bar';
        container.className = 'collectibles-bar';
        const header = document.querySelector('.header');
        header.parentNode.insertBefore(container, header.nextSibling);
    }
    container.innerHTML = `
        <div class="collectible-item">üêö ${collectibles.shells}</div>
        <div class="collectible-item">ü¶ã ${collectibles.bugs}</div>
        <div class="collectible-item">üêü ${collectibles.fish}</div>
    `;
}

function saveCollectibles() {
    if (!multData.collectibles) multData.collectibles = {};
    multData.collectibles = collectibles;
    saveMultiplicationData();
}

function loadCollectibles() {
    if (multData.collectibles) {
        collectibles = { ...collectibles, ...multData.collectibles };
    }
    renderCollectiblesBar();
}

// ‚îÄ‚îÄ Seasonal Themes ‚îÄ‚îÄ
let currentTheme = 'default';

function setTheme(theme) {
    document.body.classList.remove('theme-halloween', 'theme-christmas', 'theme-summer');
    if (theme !== 'default') {
        document.body.classList.add('theme-' + theme);
    }
    currentTheme = theme;
    renderThemeSelect();

    // Save preference
    if (multData.preferences) {
        multData.preferences.theme = theme;
    } else {
        multData.preferences = { theme };
    }
    saveMultiplicationData();
}

function renderThemeSelect() {
    let container = document.getElementById('theme-select');
    if (!container) {
        container = document.createElement('div');
        container.id = 'theme-select';
        container.className = 'theme-select';
        const header = document.querySelector('.header');
        header.appendChild(container);
    }
    container.innerHTML = `
        <button class="theme-btn ${currentTheme === 'default' ? 'active' : ''}" onclick="setTheme('default')" title="Default">üåÖ</button>
        <button class="theme-btn ${currentTheme === 'summer' ? 'active' : ''}" onclick="setTheme('summer')" title="Summer">‚òÄÔ∏è</button>
        <button class="theme-btn ${currentTheme === 'halloween' ? 'active' : ''}" onclick="setTheme('halloween')" title="Halloween">üéÉ</button>
        <button class="theme-btn ${currentTheme === 'christmas' ? 'active' : ''}" onclick="setTheme('christmas')" title="Christmas">üéÑ</button>
    `;
}

// ‚îÄ‚îÄ Background Music ‚îÄ‚îÄ
let musicPlaying = false;
let musicOscillator = null;
let musicGain = null;

function toggleMusic() {
    const btn = document.getElementById('music-toggle');

    if (musicPlaying) {
        stopMusic();
        btn.classList.add('muted');
        btn.textContent = 'üîá';
    } else {
        playBackgroundMusic();
        btn.classList.remove('muted');
        btn.textContent = 'üéµ';
    }
    musicPlaying = !musicPlaying;
}

function playBackgroundMusic() {
    try {
        // Create a simple pleasant melody loop
        const playNote = (freq, startTime, duration) => {
            const osc = audioContext.createOscillator();
            const gain = audioContext.createGain();
            osc.connect(gain);
            gain.connect(audioContext.destination);
            osc.frequency.setValueAtTime(freq, audioContext.currentTime + startTime);
            osc.type = 'sine';
            gain.gain.setValueAtTime(0.08, audioContext.currentTime + startTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + startTime + duration);
            osc.start(audioContext.currentTime + startTime);
            osc.stop(audioContext.currentTime + startTime + duration);
        };

        // Simple repeating melody
        const melody = [262, 294, 330, 349, 392, 349, 330, 294];
        let time = 0;
        melody.forEach(freq => {
            playNote(freq, time, 0.4);
            time += 0.5;
        });

        // Loop it
        if (musicPlaying) {
            setTimeout(() => {
                if (musicPlaying) playBackgroundMusic();
            }, time * 1000);
        }
    } catch(e) {
        // Audio not supported
    }
}

function stopMusic() {
    musicPlaying = false;
}

function createMusicToggle() {
    if (document.getElementById('music-toggle')) return;
    const btn = document.createElement('button');
    btn.id = 'music-toggle';
    btn.className = 'music-toggle muted';
    btn.textContent = 'üîá';
    btn.onclick = toggleMusic;
    document.body.appendChild(btn);
}

// ‚îÄ‚îÄ Bonus Questions ‚îÄ‚îÄ
let isBonusQuestion = false;
const BONUS_CHANCE = 0.1; // 10% chance

function checkBonusQuestion() {
    isBonusQuestion = Math.random() < BONUS_CHANCE;
    return isBonusQuestion;
}

function getBonusMultiplier() {
    return isBonusQuestion ? 3 : 1;
}

// Update rebuildCard to show bonus badge
const originalRebuildCard = rebuildCard;
rebuildCard = function() {
    const card = document.getElementById('card');
    const doublePointsBadge = isDoublePoints ? '<div class="double-points-badge">‚≠ê Double Points Round! ‚≠ê</div>' : '';
    const bonusBadge = isBonusQuestion ? '<div class="bonus-badge">üåü BONUS QUESTION - 3x Points! üåü</div>' : '';

    card.innerHTML = `
        ${doublePointsBadge}
        ${bonusBadge}
        <div class="question-label" id="q-label"></div>
        <div class="question-text" id="q-text"></div>
        <div id="extra"></div>
        <div class="answer-area" id="answer-area">
            <input type="number" class="answer-input" id="answer-input" autocomplete="off">
            <button class="submit-btn" id="submit-btn" onclick="submitAnswer()">Go!</button>
        </div>
        <div class="feedback" id="feedback"></div>
        <button class="next-btn" id="next-btn" onclick="nextQuestion()">Next Question</button>
    `;

    if (isBonusQuestion) {
        card.parentNode.classList.add('bonus-question');
    } else {
        card.parentNode.classList.remove('bonus-question');
    }
};

// ‚îÄ‚îÄ Leaderboard ‚îÄ‚îÄ
let leaderboard = [];

function updateLeaderboard(name, score) {
    leaderboard.push({ name, score, date: new Date().toISOString() });
    leaderboard.sort((a, b) => b.score - a.score);
    leaderboard = leaderboard.slice(0, 10); // Keep top 10

    // Save to Firebase
    if (currentUser) {
        multData.leaderboard = leaderboard;
        saveMultiplicationData();
    }
}

function showLeaderboard() {
    practiceViewActive = true;
    document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
    document.querySelector('.score-bar').style.display = 'none';

    const card = document.getElementById('card');

    let itemsHTML = '';
    if (leaderboard.length === 0) {
        itemsHTML = '<p style="text-align:center;color:#7a9a5a;">No scores yet! Play a round to get on the board!</p>';
    } else {
        leaderboard.forEach((entry, i) => {
            const rank = i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : (i + 1);
            itemsHTML += `
                <div class="leaderboard-item">
                    <div class="leaderboard-rank">${rank}</div>
                    <div class="leaderboard-name">${entry.name || 'Islander'}</div>
                    <div class="leaderboard-score">${entry.score}</div>
                </div>
            `;
        });
    }

    card.innerHTML = `
        <div class="leaderboard-view">
            <h3>üèÜ Leaderboard</h3>
            ${itemsHTML}
            <button class="back-btn" onclick="setMode('times', document.getElementById('btn-times'))">Back to Times Tables</button>
        </div>
    `;
}

// Add leaderboard button to mode select
function addLeaderboardButton() {
    const modeSelect = document.querySelector('.mode-select');
    if (!modeSelect.querySelector('#btn-leaderboard')) {
        const btn = document.createElement('button');
        btn.id = 'btn-leaderboard';
        btn.className = 'mode-btn';
        btn.innerHTML = '<span class="mode-icon">üèÜ</span>Leaderboard';
        btn.onclick = showLeaderboard;
        modeSelect.appendChild(btn);
    }
}

// ‚îÄ‚îÄ Avatar Creator ‚îÄ‚îÄ
let avatar = {
    hairColor: '#8d6e63',
    shirtColor: '#4fc3f7',
    pantsColor: '#7986cb'
};

const AVATAR_COLORS = {
    hair: ['#8d6e63', '#5d4037', '#ffeb3b', '#ff5722', '#212121', '#e91e63'],
    shirt: ['#4fc3f7', '#81c784', '#ff8a65', '#ba68c8', '#fff176', '#90a4ae'],
    pants: ['#7986cb', '#4db6ac', '#f06292', '#a1887f', '#64b5f6', '#aed581']
};

function showAvatarCreator() {
    practiceViewActive = true;
    document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
    document.querySelector('.score-bar').style.display = 'none';

    const card = document.getElementById('card');

    const colorOptions = (type) => AVATAR_COLORS[type].map(color =>
        `<div class="avatar-option ${avatar[type + 'Color'] === color ? 'selected' : ''}"
              style="background:${color}"
              onclick="setAvatarColor('${type}', '${color}')"></div>`
    ).join('');

    card.innerHTML = `
        <div class="avatar-creator">
            <h3>üé® Create Your Character</h3>
            <div class="avatar-preview" id="avatar-preview"></div>

            <div class="avatar-label">Hair Color</div>
            <div class="avatar-options">${colorOptions('hair')}</div>

            <div class="avatar-label">Shirt Color</div>
            <div class="avatar-options">${colorOptions('shirt')}</div>

            <div class="avatar-label">Pants Color</div>
            <div class="avatar-options">${colorOptions('pants')}</div>

            <button class="play-again-btn" onclick="saveAvatar()" style="margin-top:1rem">Save Character</button>
            <button class="back-btn" onclick="setMode('times', document.getElementById('btn-times'))">Cancel</button>
        </div>
    `;

    updateAvatarPreview();
}

function setAvatarColor(type, color) {
    avatar[type + 'Color'] = color;
    showAvatarCreator(); // Refresh view
}

function updateAvatarPreview() {
    const preview = document.getElementById('avatar-preview');
    if (!preview) return;

    preview.innerHTML = `
        <svg viewBox="0 0 40 60" xmlns="http://www.w3.org/2000/svg">
            <ellipse fill="${avatar.hairColor}" cx="20" cy="8" rx="10" ry="8"/>
            <circle fill="#ffcc80" cx="20" cy="12" r="9"/>
            <circle fill="#5d4037" cx="16" cy="11" r="2"/>
            <circle fill="#5d4037" cx="24" cy="11" r="2"/>
            <path d="M 16 16 Q 20 20 24 16" fill="none" stroke="#e65100" stroke-width="1.5" stroke-linecap="round"/>
            <rect fill="${avatar.shirtColor}" x="12" y="21" width="16" height="14" rx="3"/>
            <rect fill="${avatar.shirtColor}" x="4" y="22" width="8" height="4" rx="2"/>
            <rect fill="${avatar.shirtColor}" x="28" y="22" width="8" height="4" rx="2"/>
            <rect fill="${avatar.pantsColor}" x="12" y="35" width="7" height="12" rx="2"/>
            <rect fill="${avatar.pantsColor}" x="21" y="35" width="7" height="12" rx="2"/>
            <ellipse fill="#f44336" cx="15" cy="50" rx="5" ry="3"/>
            <ellipse fill="#f44336" cx="25" cy="50" rx="5" ry="3"/>
        </svg>
    `;
}

function saveAvatar() {
    // Update the runner SVG colors
    const runner = document.getElementById('runner');
    runner.querySelector('.hair').style.fill = avatar.hairColor;
    runner.querySelectorAll('.shirt').forEach(el => el.style.fill = avatar.shirtColor);
    runner.querySelectorAll('.pants').forEach(el => el.style.fill = avatar.pantsColor);

    // Save to Firebase
    if (multData.avatar) {
        multData.avatar = avatar;
    } else {
        multData.avatar = { ...avatar };
    }
    saveMultiplicationData();

    // Go back to game
    setMode('times', document.getElementById('btn-times'));
}

function loadAvatar() {
    if (multData.avatar) {
        avatar = { ...avatar, ...multData.avatar };
        const runner = document.getElementById('runner');
        if (runner) {
            runner.querySelector('.hair').style.fill = avatar.hairColor;
            runner.querySelectorAll('.shirt').forEach(el => el.style.fill = avatar.shirtColor);
            runner.querySelectorAll('.pants').forEach(el => el.style.fill = avatar.pantsColor);
        }
    }
}

// Add avatar button
function addAvatarButton() {
    const modeSelect = document.querySelector('.mode-select');
    if (!modeSelect.querySelector('#btn-avatar')) {
        const btn = document.createElement('button');
        btn.id = 'btn-avatar';
        btn.className = 'mode-btn';
        btn.innerHTML = '<span class="mode-icon">üé®</span>Character';
        btn.onclick = showAvatarCreator;
        modeSelect.appendChild(btn);
    }
}

// ‚îÄ‚îÄ Progress Map ‚îÄ‚îÄ
function showProgressMap() {
    practiceViewActive = true;
    document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
    document.querySelector('.score-bar').style.display = 'none';

    const card = document.getElementById('card');
    const unlockedCount = getUnlockedPlaces();

    // Create a visual grid of places
    let placesHTML = '';
    const positions = [
        { left: '10%', top: '10%' }, { left: '50%', top: '5%' }, { left: '85%', top: '15%' },
        { left: '20%', top: '25%' }, { left: '70%', top: '30%' },
        { left: '5%', top: '45%' }, { left: '40%', top: '40%' }, { left: '80%', top: '50%' },
        { left: '25%', top: '55%' }, { left: '60%', top: '60%' },
        { left: '10%', top: '70%' }, { left: '45%', top: '75%' }, { left: '75%', top: '70%' },
        { left: '30%', top: '85%' }, { left: '55%', top: '90%' }, { left: '85%', top: '85%' },
        { left: '15%', top: '95%' }, { left: '40%', top: '98%' }, { left: '65%', top: '95%' }, { left: '90%', top: '98%' }
    ];

    ISLAND_PLACES.forEach((place, i) => {
        const isLocked = i >= unlockedCount;
        const pos = positions[i] || { left: '50%', top: '50%' };
        placesHTML += `
            <div class="map-place ${isLocked ? 'locked' : ''}" style="left:${pos.left}; top:${pos.top}">
                <span class="place-icon">${isLocked ? 'üîí' : place.icon}</span>
                <span class="place-label">${isLocked ? '???' : place.name}</span>
            </div>
        `;
    });

    card.innerHTML = `
        <div style="text-align:center">
            <h3>üó∫Ô∏è Island Map</h3>
            <p style="color:#7a9a5a;font-size:0.9rem;margin-bottom:0.5rem">
                ${unlockedCount}/${ISLAND_PLACES.length} places discovered!
            </p>
        </div>
        <div class="progress-map">
            ${placesHTML}
        </div>
        <button class="back-btn" onclick="setMode('times', document.getElementById('btn-times'))">Back to Times Tables</button>
    `;
}

// Add map button
function addMapButton() {
    const modeSelect = document.querySelector('.mode-select');
    if (!modeSelect.querySelector('#btn-map')) {
        const btn = document.createElement('button');
        btn.id = 'btn-map';
        btn.className = 'mode-btn';
        btn.innerHTML = '<span class="mode-icon">üó∫Ô∏è</span>Map';
        btn.onclick = showProgressMap;
        modeSelect.appendChild(btn);
    }
}

// ‚îÄ‚îÄ Mini-game: Bug Catching ‚îÄ‚îÄ
let bugGameScore = 0;
let bugGameTimer = null;

function showBugGame() {
    practiceViewActive = true;
    document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
    document.querySelector('.score-bar').style.display = 'none';

    const card = document.getElementById('card');
    bugGameScore = 0;

    card.innerHTML = `
        <div class="minigame-unlock">
            <h3>ü¶ã Bug Catching Game!</h3>
            <p style="color:#5c4a32">Catch as many bugs as you can in 15 seconds!</p>
            <button class="minigame-btn" onclick="startBugGame()">Start Game!</button>
        </div>
        <button class="back-btn" onclick="setMode('times', document.getElementById('btn-times'))">Back to Times Tables</button>
    `;
}

function startBugGame() {
    const card = document.getElementById('card');
    bugGameScore = 0;

    card.innerHTML = `
        <div style="text-align:center;margin-bottom:0.5rem">
            <span id="bug-timer" style="font-weight:800;font-size:1.2rem;color:#3d7c47">15</span>s
            <span style="margin-left:1rem">Score: <span id="bug-score" style="font-weight:800;color:#c0732a">0</span></span>
        </div>
        <div class="bug-game" id="bug-area"></div>
    `;

    // Start spawning bugs
    const bugArea = document.getElementById('bug-area');
    const bugs = ['ü¶ã', 'üêõ', 'üêû', 'ü¶ó', 'üêù', 'ü™≤'];

    const spawnBug = () => {
        const bug = document.createElement('div');
        bug.className = 'bug';
        bug.textContent = pickRandom(bugs);
        bug.style.left = Math.random() * 80 + 10 + '%';
        bug.style.top = Math.random() * 80 + 10 + '%';
        bug.onclick = () => {
            bugGameScore++;
            document.getElementById('bug-score').textContent = bugGameScore;
            bug.style.transform = 'scale(0)';
            setTimeout(() => bug.remove(), 100);
            playSound('correct');
        };
        bugArea.appendChild(bug);

        // Bug flies away after 1.5s
        setTimeout(() => {
            if (bug.parentNode) bug.remove();
        }, 1500);
    };

    // Spawn bugs every 400ms
    const spawnInterval = setInterval(spawnBug, 400);

    // Countdown timer
    let timeLeft = 15;
    const timerEl = document.getElementById('bug-timer');
    const countdown = setInterval(() => {
        timeLeft--;
        timerEl.textContent = timeLeft;

        if (timeLeft <= 0) {
            clearInterval(countdown);
            clearInterval(spawnInterval);
            endBugGame();
        }
    }, 1000);
}

function endBugGame() {
    const card = document.getElementById('card');

    // Add bugs to collectibles
    collectibles.bugs += bugGameScore;
    renderCollectiblesBar();
    saveCollectibles();

    if (bugGameScore >= 10) launchConfetti();

    card.innerHTML = `
        <div style="text-align:center;padding:2rem">
            <h2 style="color:#3d7c47">ü¶ã Game Over!</h2>
            <div style="font-size:3rem;margin:1rem 0">${bugGameScore >= 10 ? 'üèÜ' : bugGameScore >= 5 ? '‚≠ê' : 'üëè'}</div>
            <div style="font-size:2rem;font-weight:800;color:#c0732a">${bugGameScore} bugs caught!</div>
            <p style="color:#7a9a5a;margin-top:0.5rem">+${bugGameScore} added to your collection!</p>
            <button class="play-again-btn" onclick="showBugGame()" style="margin-top:1rem">Play Again</button>
            <button class="back-btn" onclick="setMode('times', document.getElementById('btn-times'))">Back to Times Tables</button>
        </div>
    `;
}

// Add mini-game button
function addMinigameButton() {
    const modeSelect = document.querySelector('.mode-select');
    if (!modeSelect.querySelector('#btn-minigame')) {
        const btn = document.createElement('button');
        btn.id = 'btn-minigame';
        btn.className = 'mode-btn';
        btn.innerHTML = '<span class="mode-icon">üéÆ</span>Games';
        btn.onclick = showBugGame;
        modeSelect.appendChild(btn);
    }
}

// ‚îÄ‚îÄ Update submitAnswer to include collectibles and bonus ‚îÄ‚îÄ
const originalSubmitAnswer = submitAnswer;
submitAnswer = function() {
    if (answered) return;
    const inp = document.getElementById('answer-input');
    const userAnswer = inp.value.trim();
    if (userAnswer === '') return;

    const correct = parseInt(inp.dataset.answer);
    const isCorrect = parseInt(userAnswer) === correct;

    // In breakdown mode, handle steps
    if (currentMode === 'breakdown' && bdStep < 2) {
        if (isCorrect) {
            inp.classList.add('correct');
            bdStep++;
            setTimeout(() => {
                inp.value = '';
                inp.className = 'answer-input';
                showBreakdownStep();
                inp.focus();
            }, 600);
        } else {
            inp.classList.add('wrong');
            const feedback = document.getElementById('feedback');
            feedback.className = 'feedback wrong';
            feedback.textContent = `The answer is ${correct}. Let's keep going!`;
            bdStep++;
            setTimeout(() => {
                feedback.className = 'feedback';
                feedback.style.display = 'none';
                inp.value = '';
                inp.className = 'answer-input';
                showBreakdownStep();
                inp.focus();
            }, 1500);
        }
        return;
    }

    // Final answer (times tables or breakdown final step)
    answered = true;
    total++;
    inp.disabled = true;

    const feedback = document.getElementById('feedback');

    if (isCorrect) {
        const comboBonus = getComboBonus();
        const bonusMultiplier = getBonusMultiplier();
        score += ((isDoublePoints ? 2 : 1) + comboBonus) * bonusMultiplier;
        streak++;
        if (streak > bestStreak) bestStreak = streak;
        inp.classList.add('correct');
        feedback.className = 'feedback correct';
        playSound('correct');
        mascotReact(true);
        runCharacter();
        updateCombo(true);
        maybeCollectItem(); // Chance to find collectible!
        feedback.innerHTML = pickRandom(correctMessages);
    } else {
        streak = 0;
        inp.classList.add('wrong');
        feedback.className = 'feedback wrong';
        feedback.innerHTML = `${pickRandom(wrongMessages)} The answer was <strong>${correct}</strong>.`;
        playSound('wrong');
        mascotReact(false);
        updateCombo(false);
    }

    // Record problem for this round
    const key = problemKey(currentProblemA, currentProblemB);
    roundProblems.push({ key, correct: isCorrect });

    updateScoreboard();

    const nextBtn = document.getElementById('next-btn');
    nextBtn.style.display = 'block';
    nextBtn.textContent = total >= roundLength ? 'See Results üéâ' : 'Next Question';

    if (streak >= 5) {
        document.getElementById('streak-msg').textContent = `üî• ${streak} in a row! ${pickRandom(streakMessages)}`;
    } else if (streak >= 3) {
        document.getElementById('streak-msg').textContent = `‚ú® ${streak} in a row! Nice!`;
    } else {
        document.getElementById('streak-msg').textContent = '';
    }

    // Reset bonus question for next
    isBonusQuestion = false;
};

// ‚îÄ‚îÄ Update nextQuestion to check for bonus ‚îÄ‚îÄ
const originalNextQuestion = nextQuestion;
nextQuestion = function() {
    if (total >= roundLength) {
        isPracticeMode = false;
        showRoundEnd();
        return;
    }

    // Check for bonus question
    checkBonusQuestion();

    if (isPracticeMode) {
        nextPracticeQuestion();
    } else if (currentMode === 'times') {
        nextTimesQuestion();
    } else {
        nextBreakdownQuestion();
    }
};

// ‚îÄ‚îÄ Update showRoundEnd to add to leaderboard ‚îÄ‚îÄ
const originalShowRoundEnd = showRoundEnd;
showRoundEnd = function() {
    // Add score to leaderboard
    const name = multData.islandName || 'Islander';
    updateLeaderboard(name, score);

    // Reset powerups for next round
    powerups = { skip: 3, hint: 3 };
    renderPowerupsBar();

    // Call original
    originalShowRoundEnd();
};

// ‚îÄ‚îÄ Initialize all new features ‚îÄ‚îÄ
function initNewFeatures() {
    addLeaderboardButton();
    addAvatarButton();
    addMapButton();
    addMinigameButton();
    renderDifficultySelect();
    renderPowerupsBar();
    renderCollectiblesBar();
    renderThemeSelect();
    createMusicToggle();

    // Load saved data
    if (multData.leaderboard) leaderboard = multData.leaderboard;
    if (multData.preferences?.theme) setTheme(multData.preferences.theme);
    loadAvatar();
    loadCollectibles();
}

// Hook into data loading
const originalLoadMultiplicationData = loadMultiplicationData;
loadMultiplicationData = async function() {
    await originalLoadMultiplicationData();
    initNewFeatures();
};

// Start
renderLevelSelect();
renderPrizeButton();
initNewFeatures();
startRound();
    </script>
</body>
</html>
