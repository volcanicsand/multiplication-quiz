<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAT Verbal Practice</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Inter', sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
            color: #1a1a2e;
        }

        .container {
            max-width: 700px;
            margin: 0 auto;
            padding: 1rem;
        }

        .header {
            text-align: center;
            padding: 1.5rem 0 1rem;
        }

        .header h1 {
            font-size: 1.6rem;
            font-weight: 700;
            color: #1a1a2e;
            line-height: 1.2;
        }

        .header .subtitle {
            font-size: 0.9rem;
            color: #6b7280;
            margin-top: 0.3rem;
        }

        .user-status {
            font-size: 0.75rem;
            color: #6b7280;
            margin-top: 0.3rem;
            cursor: pointer;
        }

        .user-status:hover {
            text-decoration: underline;
        }

        .score-bar {
            display: flex;
            justify-content: space-around;
            background: white;
            border-radius: 12px;
            padding: 0.6rem 1rem;
            margin-bottom: 1rem;
            font-weight: 600;
            font-size: 0.9rem;
            border: 1px solid #e5e7eb;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .score-bar span {
            color: #4f46e5;
        }

        .mode-select {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .mode-btn {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            padding: 0.7rem 0.5rem;
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            font-size: 0.75rem;
            color: #374151;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .mode-btn:hover {
            background: #f9fafb;
            border-color: #4f46e5;
        }

        .mode-btn.active {
            background: #4f46e5;
            color: white;
            border-color: #4f46e5;
        }

        .question-card {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            border: 1px solid #e5e7eb;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .question-label {
            display: inline-block;
            font-size: 0.7rem;
            font-weight: 600;
            color: white;
            background: #4f46e5;
            padding: 0.25rem 0.6rem;
            border-radius: 20px;
            margin-bottom: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .question-label.grammar {
            background: #059669;
        }

        .question-label.vocabulary {
            background: #d97706;
        }

        .question-label.sentence {
            background: #4f46e5;
        }

        .question-text {
            font-size: 1.05rem;
            font-weight: 500;
            color: #1a1a2e;
            line-height: 1.6;
            margin-bottom: 1.2rem;
        }

        .question-text .blank {
            display: inline-block;
            min-width: 80px;
            border-bottom: 2px solid #4f46e5;
            margin: 0 0.2rem;
        }

        .question-text .underline {
            text-decoration: underline;
            text-decoration-color: #ef4444;
            text-underline-offset: 3px;
        }

        .choices {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .choice-btn {
            display: flex;
            align-items: center;
            gap: 0.8rem;
            background: #f9fafb;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            padding: 0.8rem 1rem;
            font-family: 'Inter', sans-serif;
            font-weight: 500;
            font-size: 0.95rem;
            color: #374151;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }

        .choice-btn:hover:not(.disabled) {
            background: #eef2ff;
            border-color: #4f46e5;
        }

        .choice-btn.selected {
            background: #eef2ff;
            border-color: #4f46e5;
            color: #4f46e5;
        }

        .choice-btn.correct {
            background: #d1fae5;
            border-color: #059669;
            color: #065f46;
        }

        .choice-btn.wrong {
            background: #fee2e2;
            border-color: #ef4444;
            color: #991b1b;
        }

        .choice-btn.disabled {
            cursor: default;
        }

        .choice-btn .choice-letter {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            background: #e5e7eb;
            border-radius: 50%;
            font-weight: 600;
            font-size: 0.85rem;
            flex-shrink: 0;
        }

        .choice-btn.selected .choice-letter {
            background: #4f46e5;
            color: white;
        }

        .choice-btn.correct .choice-letter {
            background: #059669;
            color: white;
        }

        .choice-btn.wrong .choice-letter {
            background: #ef4444;
            color: white;
        }

        .feedback {
            padding: 1rem;
            border-radius: 10px;
            margin-top: 1rem;
            display: none;
            font-weight: 500;
            font-size: 0.95rem;
            line-height: 1.5;
        }

        .feedback.correct {
            display: block;
            background: #d1fae5;
            color: #065f46;
        }

        .feedback.wrong {
            display: block;
            background: #fee2e2;
            color: #991b1b;
        }

        .next-btn {
            display: none;
            width: 100%;
            background: #4f46e5;
            color: white;
            border: none;
            border-radius: 10px;
            padding: 0.9rem;
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            margin-top: 1rem;
            transition: background 0.2s;
        }

        .next-btn:hover {
            background: #4338ca;
        }

        .round-end {
            text-align: center;
            padding: 1.5rem;
        }

        .round-end h2 {
            color: #1a1a2e;
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .round-end .final-score {
            font-size: 3rem;
            font-weight: 700;
            color: #4f46e5;
            margin: 0.5rem 0;
        }

        .round-end .final-msg {
            font-size: 1rem;
            color: #6b7280;
            margin-bottom: 1.5rem;
        }

        .round-end .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 0.8rem;
            margin-bottom: 1.5rem;
        }

        .round-end .stat-box {
            background: #f9fafb;
            border-radius: 10px;
            padding: 0.8rem;
        }

        .round-end .stat-label {
            font-size: 0.7rem;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .round-end .stat-value {
            font-size: 1.3rem;
            font-weight: 700;
            color: #1a1a2e;
            margin-top: 0.2rem;
        }

        .play-again-btn {
            background: #4f46e5;
            color: white;
            border: none;
            border-radius: 10px;
            padding: 0.9rem 2rem;
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: background 0.2s;
        }

        .play-again-btn:hover {
            background: #4338ca;
        }

        .login-screen {
            text-align: center;
            padding: 2rem 1rem;
        }

        .login-screen h2 {
            color: #1a1a2e;
            font-size: 1.3rem;
            margin-bottom: 0.5rem;
        }

        .login-screen p {
            color: #6b7280;
            font-size: 0.9rem;
            margin-bottom: 1.5rem;
        }

        .login-screen input {
            display: block;
            width: 100%;
            max-width: 280px;
            margin: 0 auto 0.8rem;
            padding: 0.7rem 1rem;
            font-family: 'Inter', sans-serif;
            font-size: 0.95rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            background: white;
            color: #1a1a2e;
            outline: none;
        }

        .login-screen input:focus {
            border-color: #4f46e5;
        }

        .login-btn {
            background: #4f46e5;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 0.7rem 2rem;
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: background 0.2s;
        }

        .login-btn:hover {
            background: #4338ca;
        }

        .login-error {
            color: #ef4444;
            font-size: 0.85rem;
            font-weight: 500;
            margin-top: 0.8rem;
            display: none;
        }

        .progress-view h3 {
            color: #1a1a2e;
            font-size: 1.2rem;
            margin-bottom: 0.3rem;
            text-align: center;
        }

        .progress-view .progress-subtitle {
            color: #6b7280;
            font-size: 0.9rem;
            text-align: center;
            margin-bottom: 1.2rem;
        }

        .progress-item {
            display: flex;
            align-items: center;
            gap: 0.8rem;
            padding: 0.8rem 0;
            border-bottom: 1px solid #e5e7eb;
        }

        .progress-item:last-child {
            border-bottom: none;
        }

        .progress-category {
            font-weight: 600;
            font-size: 0.9rem;
            color: #1a1a2e;
            min-width: 120px;
        }

        .progress-bar-wrap {
            flex: 1;
            background: #e5e7eb;
            border-radius: 8px;
            height: 12px;
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            border-radius: 8px;
            transition: width 0.5s;
        }

        .progress-bar-fill.sentence { background: #4f46e5; }
        .progress-bar-fill.vocabulary { background: #d97706; }
        .progress-bar-fill.grammar { background: #059669; }

        .progress-pct {
            font-weight: 600;
            font-size: 0.85rem;
            color: #6b7280;
            min-width: 45px;
            text-align: right;
        }

        .back-btn {
            display: block;
            width: 100%;
            background: #f3f4f6;
            color: #4f46e5;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            padding: 0.7rem;
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            margin-top: 1rem;
            transition: all 0.2s;
        }

        .back-btn:hover {
            background: #e5e7eb;
        }

        .alltime-stats {
            font-size: 0.85rem;
            color: #6b7280;
            margin-top: 0.5rem;
            text-align: center;
        }

        @media (max-width: 500px) {
            .header h1 { font-size: 1.3rem; }
            .question-text { font-size: 0.95rem; }
            .mode-select { grid-template-columns: 1fr; }
            .round-end .stats-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>SAT Verbal Practice</h1>
            <div class="subtitle">Sentence Completion · Vocabulary · Grammar</div>
            <div class="user-status" id="user-status" onclick="handleUserStatusClick()"></div>
        </div>

        <div id="login-screen" class="question-card" style="display:none;">
            <div class="login-screen">
                <h2>Track Your Progress</h2>
                <p>Log in to save your scores and see improvement over time.</p>
                <input type="email" id="login-email" placeholder="Email" autocomplete="email">
                <input type="password" id="login-password" placeholder="Password" autocomplete="current-password">
                <button class="login-btn" onclick="doLogin()">Log In</button>
                <div class="login-error" id="login-error"></div>
            </div>
        </div>

        <div id="game-area">
            <div class="score-bar">
                <div>Q: <span id="qnum">1</span>/<span id="qtotal">10</span></div>
                <div>Score: <span id="score">0</span></div>
                <div>Streak: <span id="streak">0</span></div>
            </div>

            <div class="mode-select">
                <button class="mode-btn active" id="btn-all" onclick="setMode('all', this)">All Types</button>
                <button class="mode-btn" id="btn-sentence" onclick="setMode('sentence', this)">Sentence</button>
                <button class="mode-btn" id="btn-vocabulary" onclick="setMode('vocabulary', this)">Vocabulary</button>
                <button class="mode-btn" id="btn-grammar" onclick="setMode('grammar', this)">Grammar</button>
                <button class="mode-btn" id="btn-progress" onclick="showProgressView()">My Progress</button>
            </div>

            <div class="question-card" id="card">
                <div class="question-label" id="q-label">Loading...</div>
                <div class="question-text" id="q-text">Loading questions...</div>
                <div class="choices" id="choices"></div>
                <div class="feedback" id="feedback"></div>
                <button class="next-btn" id="next-btn" onclick="nextQuestion()">Next Question</button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
// ── Question Bank ──
const QUESTIONS = [
    // SENTENCE COMPLETION
    {
        type: "sentence",
        text: "Despite the comedian's attempt to be funny, her jokes fell flat, leaving the audience feeling ______.",
        choices: ["amused", "unenthusiastic", "delighted", "energized"],
        correct: 1,
        explanation: "'Unenthusiastic' fits because 'fell flat' indicates the jokes didn't work."
    },
    {
        type: "sentence",
        text: "The scientist's ______ approach to research, checking every detail multiple times, ensured accurate results.",
        choices: ["careless", "meticulous", "hasty", "casual"],
        correct: 1,
        explanation: "'Meticulous' means extremely careful and precise, matching 'checking every detail multiple times.'"
    },
    {
        type: "sentence",
        text: "Although the movie received ______ reviews from critics, audiences loved it and made it a box office hit.",
        choices: ["glowing", "lukewarm", "enthusiastic", "rave"],
        correct: 1,
        explanation: "'Lukewarm' (unenthusiastic) contrasts with 'audiences loved it,' fitting the 'although' structure."
    },
    {
        type: "sentence",
        text: "The teacher's ______ explanation helped even the most confused students understand the complex concept.",
        choices: ["convoluted", "lucid", "ambiguous", "perplexing"],
        correct: 1,
        explanation: "'Lucid' means clear and easy to understand, which would help confused students."
    },
    {
        type: "sentence",
        text: "Rather than admit her mistake, Maria remained ______, insisting she had done nothing wrong.",
        choices: ["apologetic", "remorseful", "obstinate", "flexible"],
        correct: 2,
        explanation: "'Obstinate' means stubbornly refusing to change, matching someone who won't admit a mistake."
    },
    {
        type: "sentence",
        text: "The politician's ______ promises impressed voters initially, but he failed to deliver on any of them.",
        choices: ["modest", "grandiose", "realistic", "humble"],
        correct: 1,
        explanation: "'Grandiose' means impressive-sounding but often unrealistic, fitting promises that weren't kept."
    },
    {
        type: "sentence",
        text: "The medicine's effects were ______; patients felt better within minutes of taking it.",
        choices: ["gradual", "delayed", "instantaneous", "slow"],
        correct: 2,
        explanation: "'Instantaneous' means happening immediately, matching 'within minutes.'"
    },
    {
        type: "sentence",
        text: "Unlike her ______ sister who loved parties, Emma preferred quiet evenings at home with a book.",
        choices: ["introverted", "gregarious", "reserved", "shy"],
        correct: 1,
        explanation: "'Gregarious' means sociable and fond of company, contrasting with preferring quiet evenings."
    },
    {
        type: "sentence",
        text: "The documentary presented a ______ view of the issue, showing perspectives from all sides.",
        choices: ["biased", "one-sided", "balanced", "prejudiced"],
        correct: 2,
        explanation: "'Balanced' means fair and showing all perspectives, matching 'perspectives from all sides.'"
    },
    {
        type: "sentence",
        text: "After weeks of drought, the ______ rainstorm was welcomed by farmers across the region.",
        choices: ["meager", "sparse", "torrential", "light"],
        correct: 2,
        explanation: "'Torrential' means heavy and abundant, which would be welcome after a drought."
    },
    {
        type: "sentence",
        text: "The artist's early work was ______, but her later paintings showed remarkable skill and maturity.",
        choices: ["masterful", "crude", "refined", "sophisticated"],
        correct: 1,
        explanation: "'Crude' means rough or undeveloped, contrasting with 'remarkable skill and maturity' later."
    },
    {
        type: "sentence",
        text: "His ______ nature made him popular at parties, where he could talk to anyone about anything.",
        choices: ["reserved", "affable", "aloof", "distant"],
        correct: 1,
        explanation: "'Affable' means friendly and easy to talk to, matching someone popular at parties."
    },

    // VOCABULARY IN CONTEXT
    {
        type: "vocabulary",
        text: "The negotiator acted as a mediator between the two arguing parties. In this context, 'mediator' most nearly means:",
        choices: ["judge", "go-between", "competitor", "spectator"],
        correct: 1,
        explanation: "A 'mediator' is someone who helps resolve disputes between parties—a go-between."
    },
    {
        type: "vocabulary",
        text: "The professor's verbose lecture put many students to sleep. In this context, 'verbose' most nearly means:",
        choices: ["brief", "wordy", "interesting", "quiet"],
        correct: 1,
        explanation: "'Verbose' means using more words than necessary—wordy and long-winded."
    },
    {
        type: "vocabulary",
        text: "Her candid remarks surprised everyone at the meeting. In this context, 'candid' most nearly means:",
        choices: ["rehearsed", "honest", "diplomatic", "vague"],
        correct: 1,
        explanation: "'Candid' means straightforward and honest, even if surprising."
    },
    {
        type: "vocabulary",
        text: "The novel's protagonist faced an ethical dilemma. In this context, 'dilemma' most nearly means:",
        choices: ["solution", "difficult choice", "victory", "simple problem"],
        correct: 1,
        explanation: "A 'dilemma' is a situation requiring a difficult choice between options."
    },
    {
        type: "vocabulary",
        text: "The company tried to mitigate the damage from the scandal. In this context, 'mitigate' most nearly means:",
        choices: ["increase", "ignore", "lessen", "celebrate"],
        correct: 2,
        explanation: "'Mitigate' means to make less severe or reduce the impact of something negative."
    },
    {
        type: "vocabulary",
        text: "The evidence was sufficient to corroborate her story. In this context, 'corroborate' most nearly means:",
        choices: ["contradict", "confirm", "question", "ignore"],
        correct: 1,
        explanation: "'Corroborate' means to confirm or give support to a statement or theory."
    },
    {
        type: "vocabulary",
        text: "The new policy rendered the old rules obsolete. In this context, 'obsolete' most nearly means:",
        choices: ["important", "outdated", "essential", "current"],
        correct: 1,
        explanation: "'Obsolete' means no longer in use or out of date."
    },
    {
        type: "vocabulary",
        text: "She showed great tenacity in pursuing her goals. In this context, 'tenacity' most nearly means:",
        choices: ["weakness", "persistence", "laziness", "doubt"],
        correct: 1,
        explanation: "'Tenacity' means persistent determination to achieve something."
    },
    {
        type: "vocabulary",
        text: "The artist's work was considered avant-garde. In this context, 'avant-garde' most nearly means:",
        choices: ["traditional", "experimental", "ordinary", "outdated"],
        correct: 1,
        explanation: "'Avant-garde' refers to new and experimental ideas, especially in art."
    },
    {
        type: "vocabulary",
        text: "His benevolent actions helped many people in need. In this context, 'benevolent' most nearly means:",
        choices: ["selfish", "kind", "harmful", "careless"],
        correct: 1,
        explanation: "'Benevolent' means well-meaning and kindly, wanting to help others."
    },
    {
        type: "vocabulary",
        text: "The journalist tried to remain impartial when reporting the story. In this context, 'impartial' most nearly means:",
        choices: ["biased", "neutral", "opinionated", "unfair"],
        correct: 1,
        explanation: "'Impartial' means treating all sides equally without favoritism."
    },
    {
        type: "vocabulary",
        text: "The explorers found themselves in uncharted territory. In this context, 'uncharted' most nearly means:",
        choices: ["mapped", "unexplored", "familiar", "documented"],
        correct: 1,
        explanation: "'Uncharted' means not yet mapped or explored—unknown territory."
    },

    // GRAMMAR/WRITING
    {
        type: "grammar",
        text: "Which version is correct? \"Each of the students <span class='underline'>have</span> completed their assignment.\"",
        choices: ["have (no change)", "has", "are having", "were having"],
        correct: 1,
        explanation: "'Each' is singular and requires the singular verb 'has.' The correct sentence is 'Each of the students has completed their assignment.'"
    },
    {
        type: "grammar",
        text: "Which version is correct? \"The team, along with their coach, <span class='underline'>are traveling</span> to the championship.\"",
        choices: ["are traveling (no change)", "is traveling", "were traveling", "have traveled"],
        correct: 1,
        explanation: "'The team' is the subject (singular), so use 'is traveling.' The phrase 'along with their coach' doesn't change the subject."
    },
    {
        type: "grammar",
        text: "Which version is correct? \"She is one of those people who <span class='underline'>thinks</span> before speaking.\"",
        choices: ["thinks (no change)", "think", "is thinking", "has thought"],
        correct: 1,
        explanation: "'Who' refers to 'people' (plural), so use 'think.' The sentence should read 'who think before speaking.'"
    },
    {
        type: "grammar",
        text: "Which version is correct? \"Neither the teacher nor the students <span class='underline'>was</span> aware of the fire drill.\"",
        choices: ["was (no change)", "were", "is", "has been"],
        correct: 1,
        explanation: "With 'neither...nor,' the verb agrees with the nearer subject ('students' = plural), so use 'were.'"
    },
    {
        type: "grammar",
        text: "Which version is correct? \"The book, which I borrowed from the library, <span class='underline'>it was</span> very interesting.\"",
        choices: ["it was (no change)", "was", "they were", "being"],
        correct: 1,
        explanation: "'It' is redundant since 'The book' is already the subject. Remove 'it' to get 'The book...was very interesting.'"
    },
    {
        type: "grammar",
        text: "Which version is correct? \"Running through the park, <span class='underline'>the trees looked beautiful</span>.\"",
        choices: ["the trees looked beautiful (no change)", "I noticed the beautiful trees", "beautiful trees were seen", "the trees were looking beautiful"],
        correct: 1,
        explanation: "The opening phrase 'Running through the park' must modify a person, not trees. 'I noticed the beautiful trees' fixes this dangling modifier."
    },
    {
        type: "grammar",
        text: "Which version is correct? \"Between you and <span class='underline'>I</span>, this plan won't work.\"",
        choices: ["I (no change)", "me", "myself", "we"],
        correct: 1,
        explanation: "After prepositions like 'between,' use object pronouns. 'Between you and me' is correct."
    },
    {
        type: "grammar",
        text: "Which version is correct? \"The reason I was late is <span class='underline'>because</span> my car broke down.\"",
        choices: ["because (no change)", "that", "due to", "since"],
        correct: 1,
        explanation: "'The reason...is because' is redundant. Use 'The reason...is that' instead."
    },
    {
        type: "grammar",
        text: "Which version is correct? \"She felt <span class='underline'>badly</span> about missing the party.\"",
        choices: ["badly (no change)", "bad", "worse", "worst"],
        correct: 1,
        explanation: "'Feel' is a linking verb here, so use the adjective 'bad,' not the adverb 'badly.'"
    },
    {
        type: "grammar",
        text: "Which version is correct? \"<span class='underline'>Lay</span> down and rest for a while.\"",
        choices: ["Lay (no change)", "Lie", "Laid", "Lain"],
        correct: 1,
        explanation: "'Lie' means to recline (no object needed). 'Lay' means to put something down (needs an object)."
    },
    {
        type: "grammar",
        text: "Which version is correct? \"The data <span class='underline'>shows</span> a clear trend.\"",
        choices: ["shows (no change)", "show", "is showing", "has showed"],
        correct: 0,
        explanation: "While 'data' is technically plural, 'data shows' is widely accepted in modern usage. Both 'shows' and 'show' are acceptable."
    },
    {
        type: "grammar",
        text: "Which version is correct? \"Everyone should bring <span class='underline'>their</span> own lunch.\"",
        choices: ["their (no change)", "his or her", "its", "your"],
        correct: 0,
        explanation: "Singular 'they/their' is now widely accepted for gender-neutral reference. 'His or her' is also correct but more formal."
    },
    {
        type: "grammar",
        text: "Which version is correct? \"She is <span class='underline'>more smarter</span> than her brother.\"",
        choices: ["more smarter (no change)", "smarter", "most smart", "more smart"],
        correct: 1,
        explanation: "'More smarter' is a double comparative. Use either 'smarter' or 'more smart' (though 'smarter' is preferred)."
    },
    {
        type: "grammar",
        text: "Which version is correct? \"I <span class='underline'>could of</span> finished earlier if I had started sooner.\"",
        choices: ["could of (no change)", "could have", "could had", "could been"],
        correct: 1,
        explanation: "'Could of' is incorrect—it's a mishearing of 'could've' (could have). Use 'could have.'"
    }
];

// ── Firebase Setup ──
const firebaseConfig = {
    apiKey: "AIzaSyBdluf4mJiRQjwRfdFSjlMsRvG5hZ2LZS0",
    authDomain: "jtrivia-416ca.firebaseapp.com",
    projectId: "jtrivia-416ca",
    storageBucket: "jtrivia-416ca.firebasestorage.app",
    messagingSenderId: "284944131484",
    appId: "1:284944131484:web:7c549e0036aaf65550d459"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

let currentUser = null;

// Firestore data
let satData = {
    stats: { totalAnswered: 0, totalCorrect: 0, bestStreak: 0, roundsPlayed: 0 },
    categories: {
        sentence: { attempts: 0, correct: 0 },
        vocabulary: { attempts: 0, correct: 0 },
        grammar: { attempts: 0, correct: 0 }
    }
};

// ── Auth ──
auth.onAuthStateChanged(async (user) => {
    currentUser = user;
    updateAuthUI();
    if (user) {
        await loadSATData();
    }
});

function updateAuthUI() {
    const statusEl = document.getElementById('user-status');
    const loginScreen = document.getElementById('login-screen');
    const gameArea = document.getElementById('game-area');

    if (currentUser) {
        statusEl.textContent = currentUser.email + ' (log out)';
        loginScreen.style.display = 'none';
        gameArea.style.display = 'block';
    } else {
        statusEl.textContent = 'Log in to save progress';
        loginScreen.style.display = 'block';
        gameArea.style.display = 'block';
    }
}

function handleUserStatusClick() {
    if (currentUser) {
        auth.signOut();
        satData = {
            stats: { totalAnswered: 0, totalCorrect: 0, bestStreak: 0, roundsPlayed: 0 },
            categories: {
                sentence: { attempts: 0, correct: 0 },
                vocabulary: { attempts: 0, correct: 0 },
                grammar: { attempts: 0, correct: 0 }
            }
        };
    } else {
        document.getElementById('login-screen').style.display = 'block';
        document.getElementById('login-email').focus();
    }
}

async function doLogin() {
    const email = document.getElementById('login-email').value.trim();
    const password = document.getElementById('login-password').value;
    const errorEl = document.getElementById('login-error');
    errorEl.style.display = 'none';

    if (!email || !password) {
        errorEl.textContent = 'Please enter email and password.';
        errorEl.style.display = 'block';
        return;
    }

    try {
        await auth.signInWithEmailAndPassword(email, password);
    } catch (error) {
        errorEl.textContent = error.message;
        errorEl.style.display = 'block';
    }
}

document.getElementById('login-password').addEventListener('keydown', function(e) {
    if (e.key === 'Enter') doLogin();
});

// ── Firestore Data ──
async function loadSATData() {
    if (!currentUser) return;
    try {
        const doc = await db.collection('users').doc(currentUser.uid).get();
        if (doc.exists && doc.data().satVerbal) {
            const s = doc.data().satVerbal;
            satData.stats = s.stats || satData.stats;
            satData.categories = s.categories || satData.categories;
        }
    } catch (e) {
        console.log('Could not load SAT data:', e);
    }
}

async function saveSATData() {
    if (!currentUser) return;
    try {
        await db.collection('users').doc(currentUser.uid).set({
            satVerbal: satData
        }, { merge: true });
    } catch (e) {
        console.log('Could not save SAT data:', e);
    }
}

// ── Quiz State ──
const ROUND_LENGTH = 10;
let currentMode = 'all';
let score = 0;
let total = 0;
let streak = 0;
let bestStreak = 0;
let answered = false;
let currentQuestion = null;
let roundQuestions = [];
let progressViewActive = false;

function getFilteredQuestions() {
    if (currentMode === 'all') return [...QUESTIONS];
    return QUESTIONS.filter(q => q.type === currentMode);
}

function shuffleArray(arr) {
    const a = [...arr];
    for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
}

function setMode(mode, btn) {
    progressViewActive = false;
    currentMode = mode;
    document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    document.querySelector('.score-bar').style.display = '';
    startRound();
}

function startRound() {
    progressViewActive = false;
    score = 0;
    total = 0;
    streak = 0;
    bestStreak = 0;
    roundQuestions = [];

    const filtered = getFilteredQuestions();
    roundQuestions = shuffleArray(filtered).slice(0, ROUND_LENGTH);

    document.querySelector('.score-bar').style.display = '';
    updateScoreboard();
    nextQuestion();
}

function updateScoreboard() {
    document.getElementById('score').textContent = score;
    document.getElementById('streak').textContent = streak;
    document.getElementById('qnum').textContent = Math.min(total + 1, ROUND_LENGTH);
    document.getElementById('qtotal').textContent = ROUND_LENGTH;
}

function nextQuestion() {
    if (total >= ROUND_LENGTH || total >= roundQuestions.length) {
        showRoundEnd();
        return;
    }

    answered = false;
    currentQuestion = roundQuestions[total];

    const card = document.getElementById('card');
    const labelClass = currentQuestion.type;
    const labelText = currentQuestion.type === 'sentence' ? 'Sentence Completion' :
                      currentQuestion.type === 'vocabulary' ? 'Vocabulary in Context' : 'Grammar & Writing';

    const letters = ['A', 'B', 'C', 'D'];
    const choicesHTML = currentQuestion.choices.map((choice, i) => `
        <button class="choice-btn" onclick="selectChoice(${i})">
            <span class="choice-letter">${letters[i]}</span>
            <span>${choice}</span>
        </button>
    `).join('');

    card.innerHTML = `
        <div class="question-label ${labelClass}">${labelText}</div>
        <div class="question-text">${currentQuestion.text}</div>
        <div class="choices" id="choices">${choicesHTML}</div>
        <div class="feedback" id="feedback"></div>
        <button class="next-btn" id="next-btn" onclick="nextQuestion()">Next Question</button>
    `;

    updateScoreboard();
}

function selectChoice(index) {
    if (answered) return;
    answered = true;
    total++;

    const isCorrect = index === currentQuestion.correct;
    const buttons = document.querySelectorAll('.choice-btn');
    const feedback = document.getElementById('feedback');

    buttons.forEach((btn, i) => {
        btn.classList.add('disabled');
        if (i === currentQuestion.correct) {
            btn.classList.add('correct');
        } else if (i === index && !isCorrect) {
            btn.classList.add('wrong');
        }
    });

    if (isCorrect) {
        score++;
        streak++;
        if (streak > bestStreak) bestStreak = streak;
        feedback.className = 'feedback correct';
        feedback.innerHTML = `<strong>Correct!</strong> ${currentQuestion.explanation}`;
    } else {
        streak = 0;
        feedback.className = 'feedback wrong';
        feedback.innerHTML = `<strong>Not quite.</strong> ${currentQuestion.explanation}`;
    }

    // Track category stats
    satData.categories[currentQuestion.type].attempts++;
    if (isCorrect) satData.categories[currentQuestion.type].correct++;
    satData.stats.totalAnswered++;
    if (isCorrect) satData.stats.totalCorrect++;

    updateScoreboard();

    const nextBtn = document.getElementById('next-btn');
    nextBtn.style.display = 'block';
    nextBtn.textContent = total >= ROUND_LENGTH ? 'See Results' : 'Next Question';
}

function showRoundEnd() {
    const pct = Math.round((score / ROUND_LENGTH) * 100);
    let msg;
    if (pct === 100) msg = "Perfect score! Outstanding work!";
    else if (pct >= 90) msg = "Excellent! You're well prepared.";
    else if (pct >= 70) msg = "Good job! Keep practicing.";
    else if (pct >= 50) msg = "You're making progress. Keep it up!";
    else msg = "Keep studying—you'll improve with practice!";

    if (bestStreak > satData.stats.bestStreak) {
        satData.stats.bestStreak = bestStreak;
    }
    satData.stats.roundsPlayed++;
    saveSATData();

    // Calculate category breakdown for this round
    const roundStats = { sentence: {a:0,c:0}, vocabulary: {a:0,c:0}, grammar: {a:0,c:0} };
    // (simplified - just show overall for now)

    let alltimeHTML = '';
    if (currentUser && satData.stats.totalAnswered > 0) {
        const overallPct = Math.round((satData.stats.totalCorrect / satData.stats.totalAnswered) * 100);
        alltimeHTML = `<div class="alltime-stats">
            Overall: ${satData.stats.totalCorrect}/${satData.stats.totalAnswered} (${overallPct}%) · Best streak: ${satData.stats.bestStreak}
        </div>`;
    }

    const card = document.getElementById('card');
    card.innerHTML = `
        <div class="round-end">
            <h2>Round Complete!</h2>
            <div class="final-score">${score}/${ROUND_LENGTH}</div>
            <div class="final-msg">${msg}</div>
            <div class="stats-grid">
                <div class="stat-box">
                    <div class="stat-label">Accuracy</div>
                    <div class="stat-value">${pct}%</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Best Streak</div>
                    <div class="stat-value">${bestStreak}</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Rounds</div>
                    <div class="stat-value">${satData.stats.roundsPlayed}</div>
                </div>
            </div>
            ${alltimeHTML}
            <button class="play-again-btn" onclick="startRound()">Play Again</button>
        </div>
    `;
}

function showProgressView() {
    progressViewActive = true;
    document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
    document.getElementById('btn-progress').classList.add('active');
    document.querySelector('.score-bar').style.display = 'none';

    const card = document.getElementById('card');

    if (!currentUser) {
        card.innerHTML = `
            <div class="progress-view">
                <div style="text-align:center; padding:2rem; color:#6b7280;">
                    Log in to track your progress!
                </div>
                <button class="back-btn" onclick="setMode('all', document.getElementById('btn-all'))">Back to Practice</button>
            </div>
        `;
        return;
    }

    if (satData.stats.totalAnswered === 0) {
        card.innerHTML = `
            <div class="progress-view">
                <div style="text-align:center; padding:2rem; color:#6b7280;">
                    Complete some rounds to see your progress!
                </div>
                <button class="back-btn" onclick="setMode('all', document.getElementById('btn-all'))">Back to Practice</button>
            </div>
        `;
        return;
    }

    const categories = [
        { key: 'sentence', label: 'Sentence Completion' },
        { key: 'vocabulary', label: 'Vocabulary' },
        { key: 'grammar', label: 'Grammar & Writing' }
    ];

    let itemsHTML = '';
    for (const cat of categories) {
        const data = satData.categories[cat.key];
        const pct = data.attempts > 0 ? Math.round((data.correct / data.attempts) * 100) : 0;
        itemsHTML += `
            <div class="progress-item">
                <div class="progress-category">${cat.label}</div>
                <div class="progress-bar-wrap">
                    <div class="progress-bar-fill ${cat.key}" style="width: ${pct}%"></div>
                </div>
                <div class="progress-pct">${pct}%</div>
            </div>
        `;
    }

    const overallPct = Math.round((satData.stats.totalCorrect / satData.stats.totalAnswered) * 100);

    card.innerHTML = `
        <div class="progress-view">
            <h3>Your Progress</h3>
            <div class="progress-subtitle">${satData.stats.totalAnswered} questions answered · ${overallPct}% overall</div>
            ${itemsHTML}
            <div style="text-align:center; margin-top:1rem; color:#6b7280; font-size:0.85rem;">
                Best streak: ${satData.stats.bestStreak} · Rounds played: ${satData.stats.roundsPlayed}
            </div>
            <button class="back-btn" onclick="setMode('all', document.getElementById('btn-all'))">Back to Practice</button>
        </div>
    `;
}

// Enter key handling
document.addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
        if (document.activeElement && document.activeElement.id === 'login-email') {
            document.getElementById('login-password').focus();
            return;
        }
        if (document.activeElement && document.activeElement.id === 'login-password') {
            doLogin();
            return;
        }
        if (progressViewActive) return;

        const nextBtn = document.getElementById('next-btn');
        if (nextBtn && nextBtn.style.display === 'block') {
            nextQuestion();
        }
    }

    // A, B, C, D keys for selecting choices
    if (!answered && !progressViewActive && currentQuestion) {
        const key = e.key.toUpperCase();
        const index = ['A', 'B', 'C', 'D'].indexOf(key);
        if (index !== -1 && index < currentQuestion.choices.length) {
            selectChoice(index);
        }
    }
});

// Start
startRound();
    </script>
</body>
</html>
